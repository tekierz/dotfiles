package tools

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"

	"github.com/tekierz/dotfiles/internal/pkg"
)

// BtopConfig holds btop configuration settings
type BtopConfig struct {
	Theme     string // "auto", "Default", "TTY", custom theme name
	UpdateMs  int    // Update interval in milliseconds
	ShowTemp  bool   // Show temperature sensors
	GraphType string // "braille", "block", "tty"
}

// BtopTool represents btop system monitor
type BtopTool struct {
	BaseTool
}

// NewBtopTool creates a new btop tool
func NewBtopTool() *BtopTool {
	home, _ := os.UserHomeDir()
	return &BtopTool{
		BaseTool: BaseTool{
			id:          "btop",
			name:        "btop",
			description: "Resource monitor with TUI",
			icon:        "ó°„¨",
			category:    CategoryUtility,
			packages: map[pkg.Platform][]string{
				pkg.PlatformMacOS:  {"btop"},
				pkg.PlatformArch:   {"btop"},
				pkg.PlatformDebian: {"btop"},
			},
			configPaths: []string{
				filepath.Join(home, ".config", "btop", "btop.conf"),
			},
			heavyTool: true, // Skip on low-memory systems (Pi Zero 2)
			// UI metadata
			uiGroup:        UIGroupCLITools,
			configScreen:   30, // ScreenConfigBtop - has dedicated config screen
			defaultEnabled: true,
		},
	}
}

// GenerateBtopConfig builds the btop.conf content
func GenerateBtopConfig(cfg BtopConfig, theme string) string {
	var sb strings.Builder

	// Header
	sb.WriteString("#? Generated by dotfiles TUI\n")
	sb.WriteString(fmt.Sprintf("#? Theme: %s\n\n", theme))

	// Color theme
	sb.WriteString("#* Color theme\n")
	btopTheme := cfg.Theme
	if btopTheme == "auto" {
		btopTheme = "Default"
	}
	sb.WriteString(fmt.Sprintf("color_theme = \"%s\"\n\n", btopTheme))

	// Update interval
	sb.WriteString("#* Update time in milliseconds\n")
	sb.WriteString(fmt.Sprintf("update_ms = %d\n\n", cfg.UpdateMs))

	// Process sorting
	sb.WriteString("#* Processes sorting\n")
	sb.WriteString("proc_sorting = \"cpu lazy\"\n")
	sb.WriteString("proc_reversed = false\n")
	sb.WriteString("proc_tree = false\n")
	sb.WriteString("proc_colors = true\n")
	sb.WriteString("proc_gradient = true\n")
	sb.WriteString("proc_per_core = false\n")
	sb.WriteString("proc_mem_bytes = true\n\n")

	// Graph settings
	sb.WriteString("#* Graph settings\n")
	sb.WriteString(fmt.Sprintf("graph_symbol = \"%s\"\n", cfg.GraphType))
	sb.WriteString("graph_symbol_cpu = \"default\"\n")
	sb.WriteString("graph_symbol_mem = \"default\"\n")
	sb.WriteString("graph_symbol_net = \"default\"\n")
	sb.WriteString("graph_symbol_proc = \"default\"\n")
	sb.WriteString("shown_boxes = \"cpu mem net proc\"\n\n")

	// Temperature
	sb.WriteString("#* Temperature\n")
	sb.WriteString(fmt.Sprintf("show_coretemp = %t\n", cfg.ShowTemp))
	sb.WriteString("temp_scale = \"celsius\"\n\n")

	// Memory
	sb.WriteString("#* Memory\n")
	sb.WriteString("mem_graphs = true\n")
	sb.WriteString("mem_below_net = false\n")
	sb.WriteString("show_swap = true\n")
	sb.WriteString("swap_disk = true\n")
	sb.WriteString("show_disks = true\n")
	sb.WriteString("only_physical = true\n")
	sb.WriteString("use_fstab = false\n")
	sb.WriteString("show_io_stat = true\n")
	sb.WriteString("io_mode = false\n")
	sb.WriteString("io_graph_combined = false\n\n")

	// Network
	sb.WriteString("#* Network\n")
	sb.WriteString("net_download = 100\n")
	sb.WriteString("net_upload = 100\n")
	sb.WriteString("net_auto = true\n")
	sb.WriteString("net_sync = false\n")
	sb.WriteString("net_iface = \"\"\n\n")

	// General
	sb.WriteString("#* General\n")
	sb.WriteString("vim_keys = true\n")
	sb.WriteString("rounded_corners = true\n")
	sb.WriteString("clock_format = \"%X\"\n")
	sb.WriteString("background_update = true\n")
	sb.WriteString("update_check = false\n")
	sb.WriteString("log_level = \"WARNING\"\n")

	return sb.String()
}

// WriteBtopConfig writes the btop config to disk
func WriteBtopConfig(cfg BtopConfig, theme string) error {
	home, err := os.UserHomeDir()
	if err != nil {
		return fmt.Errorf("failed to get home directory: %w", err)
	}

	configDir := filepath.Join(home, ".config", "btop")
	if err := os.MkdirAll(configDir, 0700); err != nil {
		return fmt.Errorf("failed to create btop config directory: %w", err)
	}

	configPath := filepath.Join(configDir, "btop.conf")
	content := GenerateBtopConfig(cfg, theme)

	if err := os.WriteFile(configPath, []byte(content), 0600); err != nil {
		return fmt.Errorf("failed to write btop config: %w", err)
	}

	return nil
}

// GenerateConfig implements Tool interface (uses defaults)
func (t *BtopTool) GenerateConfig(theme string) string {
	cfg := BtopConfig{
		Theme:     "auto",
		UpdateMs:  2000,
		ShowTemp:  true,
		GraphType: "braille",
	}
	return GenerateBtopConfig(cfg, theme)
}

// ApplyConfig implements Tool interface (uses defaults)
func (t *BtopTool) ApplyConfig(theme string) error {
	cfg := BtopConfig{
		Theme:     "auto",
		UpdateMs:  2000,
		ShowTemp:  true,
		GraphType: "braille",
	}
	return WriteBtopConfig(cfg, theme)
}
