package tools

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"

	"github.com/tekierz/dotfiles/internal/pkg"
)

// LazyGitConfig holds LazyGit configuration settings
type LazyGitConfig struct {
	SideBySide bool
	MouseMode  bool
	Theme      string // "auto", "dark", "light"
}

// LazyGitTool represents LazyGit TUI for Git
type LazyGitTool struct {
	BaseTool
}

// NewLazyGitTool creates a new LazyGit tool
func NewLazyGitTool() *LazyGitTool {
	home, _ := os.UserHomeDir()
	return &LazyGitTool{
		BaseTool: BaseTool{
			id:          "lazygit",
			name:        "LazyGit",
			description: "Simple terminal UI for Git commands",
			icon:        "ó°Š¢",
			category:    CategoryGit,
			packages: map[pkg.Platform][]string{
				pkg.PlatformMacOS:  {"lazygit"},
				pkg.PlatformArch:   {"lazygit"},
				pkg.PlatformDebian: {"lazygit"},
			},
			configPaths: []string{
				filepath.Join(home, ".config", "lazygit", "config.yml"),
			},
			// UI metadata
			uiGroup:        UIGroupCLITools,
			configScreen:   28, // ScreenConfigLazyGit - has dedicated config screen
			defaultEnabled: true,
		},
	}
}

// GenerateLazyGitConfig builds the lazygit config.yml content
func GenerateLazyGitConfig(cfg LazyGitConfig, theme string) string {
	var sb strings.Builder

	// Header
	sb.WriteString("# Generated by dotfiles TUI\n")
	sb.WriteString(fmt.Sprintf("# Theme: %s\n\n", theme))

	// GUI settings
	sb.WriteString("gui:\n")
	if cfg.SideBySide {
		sb.WriteString("  sidePanelWidth: 0.3333\n")
	}
	sb.WriteString("  scrollHeight: 2\n")
	sb.WriteString("  scrollPastBottom: true\n")
	sb.WriteString("  mouseEvents: " + fmt.Sprintf("%t", cfg.MouseMode) + "\n")
	sb.WriteString("  skipDiscardChangeWarning: false\n")
	sb.WriteString("  skipStashWarning: false\n")
	sb.WriteString("  showFileTree: true\n")
	sb.WriteString("  showRandomTip: false\n")
	sb.WriteString("  showCommandLog: true\n")
	sb.WriteString("  showBottomLine: true\n")
	sb.WriteString("  nerdFontsVersion: \"3\"\n\n")

	// Git settings
	sb.WriteString("git:\n")
	sb.WriteString("  paging:\n")
	sb.WriteString("    colorArg: always\n")
	sb.WriteString("    pager: delta --dark --paging=never\n")
	sb.WriteString("  commit:\n")
	sb.WriteString("    signOff: false\n")
	sb.WriteString("  merging:\n")
	sb.WriteString("    manualCommit: false\n")
	sb.WriteString("    args: \"\"\n")
	sb.WriteString("  log:\n")
	sb.WriteString("    order: topo-order\n")
	sb.WriteString("    showGraph: always\n")
	sb.WriteString("  skipHookPrefix: WIP\n")
	sb.WriteString("  autoFetch: true\n")
	sb.WriteString("  autoRefresh: true\n")
	sb.WriteString("  branchLogCmd: git log --graph --color=always --abbrev-commit --decorate --date=relative --pretty=medium {{branchName}} --\n\n")

	// OS settings
	sb.WriteString("os:\n")
	sb.WriteString("  editPreset: nvim\n\n")

	// Keybinding hints
	sb.WriteString("keybinding:\n")
	sb.WriteString("  universal:\n")
	sb.WriteString("    quit: q\n")
	sb.WriteString("    quit-alt1: <c-c>\n")
	sb.WriteString("    return: <esc>\n")
	sb.WriteString("    togglePanel: <tab>\n")
	sb.WriteString("    prevItem: <up>\n")
	sb.WriteString("    nextItem: <down>\n")
	sb.WriteString("    prevPage: <pgup>\n")
	sb.WriteString("    nextPage: <pgdown>\n")
	sb.WriteString("    scrollLeft: <left>\n")
	sb.WriteString("    scrollRight: <right>\n")

	return sb.String()
}

// WriteLazyGitConfig writes the lazygit config to disk
func WriteLazyGitConfig(cfg LazyGitConfig, theme string) error {
	home, err := os.UserHomeDir()
	if err != nil {
		return fmt.Errorf("failed to get home directory: %w", err)
	}

	configDir := filepath.Join(home, ".config", "lazygit")
	if err := os.MkdirAll(configDir, 0700); err != nil {
		return fmt.Errorf("failed to create lazygit config directory: %w", err)
	}

	configPath := filepath.Join(configDir, "config.yml")
	content := GenerateLazyGitConfig(cfg, theme)

	if err := os.WriteFile(configPath, []byte(content), 0600); err != nil {
		return fmt.Errorf("failed to write lazygit config: %w", err)
	}

	return nil
}

// GenerateConfig implements Tool interface (uses defaults)
func (t *LazyGitTool) GenerateConfig(theme string) string {
	cfg := LazyGitConfig{
		SideBySide: true,
		MouseMode:  true,
		Theme:      "auto",
	}
	return GenerateLazyGitConfig(cfg, theme)
}

// ApplyConfig implements Tool interface (uses defaults)
func (t *LazyGitTool) ApplyConfig(theme string) error {
	cfg := LazyGitConfig{
		SideBySide: true,
		MouseMode:  true,
		Theme:      "auto",
	}
	return WriteLazyGitConfig(cfg, theme)
}
