#!/usr/bin/env bash
#
# Dotfiles Setup Script
# https://github.com/tekierz/dotfiles
# Sets up terminal environment on macOS, Linux (Arch-based), or Raspberry Pi
# Theme: Catppuccin Mocha
#

set -euo pipefail

VERSION="1.0.1"

# Default flags
INSTALL_MACOS_APPS=false
RASPI_MODE=false
RASPI_MODEL=""
SKIP_PROMPTS=false
SKIP_BACKUP=false
DO_LIST_BACKUPS=false
DO_RESTORE=false
RESTORE_SESSION=""
NAV_STYLE="emacs"  # "emacs" (default, beginner-friendly) or "vim"
THEME="catppuccin-mocha"  # Default theme

# Supported themes
SUPPORTED_THEMES="catppuccin-mocha catppuccin-latte catppuccin-frappe catppuccin-macchiato dracula gruvbox-dark gruvbox-light nord tokyo-night solarized-dark solarized-light monokai rose-pine"

# Settings directory
DOTFILES_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/dotfiles"
DOTFILES_BACKUP_DIR="$DOTFILES_CONFIG_DIR/backups"
BACKUP_MANIFEST=""

# Load theme colors based on selected theme
load_theme_colors() {
    local theme="${1:-$THEME}"

    case "$theme" in
        catppuccin-mocha)
            # Catppuccin Mocha - Dark, warm pastels
            T_BG="#1e1e2e"; T_FG="#cdd6f4"
            T_CURSOR="#f5e0dc"; T_CURSOR_TEXT="#1e1e2e"
            T_SEL_BG="#585b70"; T_SEL_FG="#cdd6f4"
            T_BLACK="#45475a"; T_BRIGHT_BLACK="#585b70"
            T_RED="#f38ba8"; T_BRIGHT_RED="#f38ba8"
            T_GREEN="#a6e3a1"; T_BRIGHT_GREEN="#a6e3a1"
            T_YELLOW="#f9e2af"; T_BRIGHT_YELLOW="#f9e2af"
            T_BLUE="#89b4fa"; T_BRIGHT_BLUE="#89b4fa"
            T_MAGENTA="#f5c2e7"; T_BRIGHT_MAGENTA="#f5c2e7"
            T_CYAN="#94e2d5"; T_BRIGHT_CYAN="#94e2d5"
            T_WHITE="#bac2de"; T_BRIGHT_WHITE="#a6adc8"
            # UI accents
            T_ACCENT="#89b4fa"; T_ACCENT2="#a6e3a1"; T_ACCENT3="#f38ba8"
            T_SURFACE="#313244"; T_OVERLAY="#45475a"; T_MUTED="#6c7086"
            T_BAT_THEME="Catppuccin Mocha"; T_DELTA_THEME="Catppuccin Mocha"
            T_IS_LIGHT=false
            ;;
        catppuccin-latte)
            # Catppuccin Latte - Light, warm pastels
            T_BG="#eff1f5"; T_FG="#4c4f69"
            T_CURSOR="#dc8a78"; T_CURSOR_TEXT="#eff1f5"
            T_SEL_BG="#acb0be"; T_SEL_FG="#4c4f69"
            T_BLACK="#5c5f77"; T_BRIGHT_BLACK="#6c6f85"
            T_RED="#d20f39"; T_BRIGHT_RED="#d20f39"
            T_GREEN="#40a02b"; T_BRIGHT_GREEN="#40a02b"
            T_YELLOW="#df8e1d"; T_BRIGHT_YELLOW="#df8e1d"
            T_BLUE="#1e66f5"; T_BRIGHT_BLUE="#1e66f5"
            T_MAGENTA="#ea76cb"; T_BRIGHT_MAGENTA="#ea76cb"
            T_CYAN="#179299"; T_BRIGHT_CYAN="#179299"
            T_WHITE="#acb0be"; T_BRIGHT_WHITE="#bcc0cc"
            T_ACCENT="#1e66f5"; T_ACCENT2="#40a02b"; T_ACCENT3="#d20f39"
            T_SURFACE="#ccd0da"; T_OVERLAY="#bcc0cc"; T_MUTED="#8c8fa1"
            T_BAT_THEME="Catppuccin Latte"; T_DELTA_THEME="Catppuccin Latte"
            T_IS_LIGHT=true
            ;;
        catppuccin-frappe)
            # Catppuccin Frappé - Medium dark, muted pastels
            T_BG="#303446"; T_FG="#c6d0f5"
            T_CURSOR="#f2d5cf"; T_CURSOR_TEXT="#303446"
            T_SEL_BG="#626880"; T_SEL_FG="#c6d0f5"
            T_BLACK="#51576d"; T_BRIGHT_BLACK="#626880"
            T_RED="#e78284"; T_BRIGHT_RED="#e78284"
            T_GREEN="#a6d189"; T_BRIGHT_GREEN="#a6d189"
            T_YELLOW="#e5c890"; T_BRIGHT_YELLOW="#e5c890"
            T_BLUE="#8caaee"; T_BRIGHT_BLUE="#8caaee"
            T_MAGENTA="#f4b8e4"; T_BRIGHT_MAGENTA="#f4b8e4"
            T_CYAN="#81c8be"; T_BRIGHT_CYAN="#81c8be"
            T_WHITE="#b5bfe2"; T_BRIGHT_WHITE="#a5adce"
            T_ACCENT="#8caaee"; T_ACCENT2="#a6d189"; T_ACCENT3="#e78284"
            T_SURFACE="#414559"; T_OVERLAY="#51576d"; T_MUTED="#737994"
            T_BAT_THEME="Catppuccin Frappe"; T_DELTA_THEME="Catppuccin Frappe"
            T_IS_LIGHT=false
            ;;
        catppuccin-macchiato)
            # Catppuccin Macchiato - Dark, warm muted
            T_BG="#24273a"; T_FG="#cad3f5"
            T_CURSOR="#f4dbd6"; T_CURSOR_TEXT="#24273a"
            T_SEL_BG="#5b6078"; T_SEL_FG="#cad3f5"
            T_BLACK="#494d64"; T_BRIGHT_BLACK="#5b6078"
            T_RED="#ed8796"; T_BRIGHT_RED="#ed8796"
            T_GREEN="#a6da95"; T_BRIGHT_GREEN="#a6da95"
            T_YELLOW="#eed49f"; T_BRIGHT_YELLOW="#eed49f"
            T_BLUE="#8aadf4"; T_BRIGHT_BLUE="#8aadf4"
            T_MAGENTA="#f5bde6"; T_BRIGHT_MAGENTA="#f5bde6"
            T_CYAN="#8bd5ca"; T_BRIGHT_CYAN="#8bd5ca"
            T_WHITE="#b8c0e0"; T_BRIGHT_WHITE="#a5adcb"
            T_ACCENT="#8aadf4"; T_ACCENT2="#a6da95"; T_ACCENT3="#ed8796"
            T_SURFACE="#363a4f"; T_OVERLAY="#494d64"; T_MUTED="#6e738d"
            T_BAT_THEME="Catppuccin Macchiato"; T_DELTA_THEME="Catppuccin Macchiato"
            T_IS_LIGHT=false
            ;;
        dracula)
            # Dracula - Dark with vibrant purples and pinks
            T_BG="#282a36"; T_FG="#f8f8f2"
            T_CURSOR="#f8f8f2"; T_CURSOR_TEXT="#282a36"
            T_SEL_BG="#44475a"; T_SEL_FG="#f8f8f2"
            T_BLACK="#21222c"; T_BRIGHT_BLACK="#6272a4"
            T_RED="#ff5555"; T_BRIGHT_RED="#ff6e6e"
            T_GREEN="#50fa7b"; T_BRIGHT_GREEN="#69ff94"
            T_YELLOW="#f1fa8c"; T_BRIGHT_YELLOW="#ffffa5"
            T_BLUE="#bd93f9"; T_BRIGHT_BLUE="#d6acff"
            T_MAGENTA="#ff79c6"; T_BRIGHT_MAGENTA="#ff92df"
            T_CYAN="#8be9fd"; T_BRIGHT_CYAN="#a4ffff"
            T_WHITE="#f8f8f2"; T_BRIGHT_WHITE="#ffffff"
            T_ACCENT="#bd93f9"; T_ACCENT2="#50fa7b"; T_ACCENT3="#ff79c6"
            T_SURFACE="#44475a"; T_OVERLAY="#6272a4"; T_MUTED="#6272a4"
            T_BAT_THEME="Dracula"; T_DELTA_THEME="Dracula"
            T_IS_LIGHT=false
            ;;
        gruvbox-dark)
            # Gruvbox Dark - Retro warm browns and oranges
            T_BG="#282828"; T_FG="#ebdbb2"
            T_CURSOR="#ebdbb2"; T_CURSOR_TEXT="#282828"
            T_SEL_BG="#504945"; T_SEL_FG="#ebdbb2"
            T_BLACK="#282828"; T_BRIGHT_BLACK="#928374"
            T_RED="#cc241d"; T_BRIGHT_RED="#fb4934"
            T_GREEN="#98971a"; T_BRIGHT_GREEN="#b8bb26"
            T_YELLOW="#d79921"; T_BRIGHT_YELLOW="#fabd2f"
            T_BLUE="#458588"; T_BRIGHT_BLUE="#83a598"
            T_MAGENTA="#b16286"; T_BRIGHT_MAGENTA="#d3869b"
            T_CYAN="#689d6a"; T_BRIGHT_CYAN="#8ec07c"
            T_WHITE="#a89984"; T_BRIGHT_WHITE="#ebdbb2"
            T_ACCENT="#83a598"; T_ACCENT2="#b8bb26"; T_ACCENT3="#fb4934"
            T_SURFACE="#3c3836"; T_OVERLAY="#504945"; T_MUTED="#928374"
            T_BAT_THEME="gruvbox-dark"; T_DELTA_THEME="gruvbox-dark"
            T_IS_LIGHT=false
            ;;
        gruvbox-light)
            # Gruvbox Light - Warm paper-like tones
            T_BG="#fbf1c7"; T_FG="#3c3836"
            T_CURSOR="#3c3836"; T_CURSOR_TEXT="#fbf1c7"
            T_SEL_BG="#d5c4a1"; T_SEL_FG="#3c3836"
            T_BLACK="#fbf1c7"; T_BRIGHT_BLACK="#928374"
            T_RED="#cc241d"; T_BRIGHT_RED="#9d0006"
            T_GREEN="#98971a"; T_BRIGHT_GREEN="#79740e"
            T_YELLOW="#d79921"; T_BRIGHT_YELLOW="#b57614"
            T_BLUE="#458588"; T_BRIGHT_BLUE="#076678"
            T_MAGENTA="#b16286"; T_BRIGHT_MAGENTA="#8f3f71"
            T_CYAN="#689d6a"; T_BRIGHT_CYAN="#427b58"
            T_WHITE="#7c6f64"; T_BRIGHT_WHITE="#3c3836"
            T_ACCENT="#076678"; T_ACCENT2="#79740e"; T_ACCENT3="#9d0006"
            T_SURFACE="#ebdbb2"; T_OVERLAY="#d5c4a1"; T_MUTED="#928374"
            T_BAT_THEME="gruvbox-light"; T_DELTA_THEME="gruvbox-light"
            T_IS_LIGHT=true
            ;;
        nord)
            # Nord - Arctic cool blues and grays
            T_BG="#2e3440"; T_FG="#d8dee9"
            T_CURSOR="#d8dee9"; T_CURSOR_TEXT="#2e3440"
            T_SEL_BG="#434c5e"; T_SEL_FG="#d8dee9"
            T_BLACK="#3b4252"; T_BRIGHT_BLACK="#4c566a"
            T_RED="#bf616a"; T_BRIGHT_RED="#bf616a"
            T_GREEN="#a3be8c"; T_BRIGHT_GREEN="#a3be8c"
            T_YELLOW="#ebcb8b"; T_BRIGHT_YELLOW="#ebcb8b"
            T_BLUE="#81a1c1"; T_BRIGHT_BLUE="#81a1c1"
            T_MAGENTA="#b48ead"; T_BRIGHT_MAGENTA="#b48ead"
            T_CYAN="#88c0d0"; T_BRIGHT_CYAN="#8fbcbb"
            T_WHITE="#e5e9f0"; T_BRIGHT_WHITE="#eceff4"
            T_ACCENT="#88c0d0"; T_ACCENT2="#a3be8c"; T_ACCENT3="#bf616a"
            T_SURFACE="#3b4252"; T_OVERLAY="#434c5e"; T_MUTED="#4c566a"
            T_BAT_THEME="Nord"; T_DELTA_THEME="Nord"
            T_IS_LIGHT=false
            ;;
        tokyo-night)
            # Tokyo Night - Rich purples and blues
            T_BG="#1a1b26"; T_FG="#a9b1d6"
            T_CURSOR="#c0caf5"; T_CURSOR_TEXT="#1a1b26"
            T_SEL_BG="#33467c"; T_SEL_FG="#c0caf5"
            T_BLACK="#15161e"; T_BRIGHT_BLACK="#414868"
            T_RED="#f7768e"; T_BRIGHT_RED="#f7768e"
            T_GREEN="#9ece6a"; T_BRIGHT_GREEN="#9ece6a"
            T_YELLOW="#e0af68"; T_BRIGHT_YELLOW="#e0af68"
            T_BLUE="#7aa2f7"; T_BRIGHT_BLUE="#7aa2f7"
            T_MAGENTA="#bb9af7"; T_BRIGHT_MAGENTA="#bb9af7"
            T_CYAN="#7dcfff"; T_BRIGHT_CYAN="#7dcfff"
            T_WHITE="#a9b1d6"; T_BRIGHT_WHITE="#c0caf5"
            T_ACCENT="#7aa2f7"; T_ACCENT2="#9ece6a"; T_ACCENT3="#f7768e"
            T_SURFACE="#24283b"; T_OVERLAY="#414868"; T_MUTED="#565f89"
            T_BAT_THEME="TwoDark"; T_DELTA_THEME="TwoDark"
            T_IS_LIGHT=false
            ;;
        solarized-dark)
            # Solarized Dark - Low contrast, easy on eyes
            T_BG="#002b36"; T_FG="#839496"
            T_CURSOR="#839496"; T_CURSOR_TEXT="#002b36"
            T_SEL_BG="#073642"; T_SEL_FG="#93a1a1"
            T_BLACK="#073642"; T_BRIGHT_BLACK="#586e75"
            T_RED="#dc322f"; T_BRIGHT_RED="#cb4b16"
            T_GREEN="#859900"; T_BRIGHT_GREEN="#586e75"
            T_YELLOW="#b58900"; T_BRIGHT_YELLOW="#657b83"
            T_BLUE="#268bd2"; T_BRIGHT_BLUE="#839496"
            T_MAGENTA="#d33682"; T_BRIGHT_MAGENTA="#6c71c4"
            T_CYAN="#2aa198"; T_BRIGHT_CYAN="#93a1a1"
            T_WHITE="#eee8d5"; T_BRIGHT_WHITE="#fdf6e3"
            T_ACCENT="#268bd2"; T_ACCENT2="#859900"; T_ACCENT3="#dc322f"
            T_SURFACE="#073642"; T_OVERLAY="#586e75"; T_MUTED="#657b83"
            T_BAT_THEME="Solarized (dark)"; T_DELTA_THEME="Solarized (dark)"
            T_IS_LIGHT=false
            ;;
        solarized-light)
            # Solarized Light - Low contrast light theme
            T_BG="#fdf6e3"; T_FG="#657b83"
            T_CURSOR="#657b83"; T_CURSOR_TEXT="#fdf6e3"
            T_SEL_BG="#eee8d5"; T_SEL_FG="#586e75"
            T_BLACK="#073642"; T_BRIGHT_BLACK="#002b36"
            T_RED="#dc322f"; T_BRIGHT_RED="#cb4b16"
            T_GREEN="#859900"; T_BRIGHT_GREEN="#586e75"
            T_YELLOW="#b58900"; T_BRIGHT_YELLOW="#657b83"
            T_BLUE="#268bd2"; T_BRIGHT_BLUE="#839496"
            T_MAGENTA="#d33682"; T_BRIGHT_MAGENTA="#6c71c4"
            T_CYAN="#2aa198"; T_BRIGHT_CYAN="#93a1a1"
            T_WHITE="#eee8d5"; T_BRIGHT_WHITE="#fdf6e3"
            T_ACCENT="#268bd2"; T_ACCENT2="#859900"; T_ACCENT3="#dc322f"
            T_SURFACE="#eee8d5"; T_OVERLAY="#93a1a1"; T_MUTED="#839496"
            T_BAT_THEME="Solarized (light)"; T_DELTA_THEME="Solarized (light)"
            T_IS_LIGHT=true
            ;;
        monokai)
            # Monokai - Classic vibrant theme
            T_BG="#272822"; T_FG="#f8f8f2"
            T_CURSOR="#f8f8f2"; T_CURSOR_TEXT="#272822"
            T_SEL_BG="#49483e"; T_SEL_FG="#f8f8f2"
            T_BLACK="#272822"; T_BRIGHT_BLACK="#75715e"
            T_RED="#f92672"; T_BRIGHT_RED="#f92672"
            T_GREEN="#a6e22e"; T_BRIGHT_GREEN="#a6e22e"
            T_YELLOW="#f4bf75"; T_BRIGHT_YELLOW="#f4bf75"
            T_BLUE="#66d9ef"; T_BRIGHT_BLUE="#66d9ef"
            T_MAGENTA="#ae81ff"; T_BRIGHT_MAGENTA="#ae81ff"
            T_CYAN="#a1efe4"; T_BRIGHT_CYAN="#a1efe4"
            T_WHITE="#f8f8f2"; T_BRIGHT_WHITE="#f9f8f5"
            T_ACCENT="#66d9ef"; T_ACCENT2="#a6e22e"; T_ACCENT3="#f92672"
            T_SURFACE="#3e3d32"; T_OVERLAY="#49483e"; T_MUTED="#75715e"
            T_BAT_THEME="Monokai Extended"; T_DELTA_THEME="Monokai Extended"
            T_IS_LIGHT=false
            ;;
        rose-pine)
            # Rosé Pine - Soft muted pinks and greens
            T_BG="#191724"; T_FG="#e0def4"
            T_CURSOR="#524f67"; T_CURSOR_TEXT="#e0def4"
            T_SEL_BG="#403d52"; T_SEL_FG="#e0def4"
            T_BLACK="#26233a"; T_BRIGHT_BLACK="#6e6a86"
            T_RED="#eb6f92"; T_BRIGHT_RED="#eb6f92"
            T_GREEN="#9ccfd8"; T_BRIGHT_GREEN="#9ccfd8"
            T_YELLOW="#f6c177"; T_BRIGHT_YELLOW="#f6c177"
            T_BLUE="#31748f"; T_BRIGHT_BLUE="#31748f"
            T_MAGENTA="#c4a7e7"; T_BRIGHT_MAGENTA="#c4a7e7"
            T_CYAN="#ebbcba"; T_BRIGHT_CYAN="#ebbcba"
            T_WHITE="#e0def4"; T_BRIGHT_WHITE="#e0def4"
            T_ACCENT="#c4a7e7"; T_ACCENT2="#9ccfd8"; T_ACCENT3="#eb6f92"
            T_SURFACE="#1f1d2e"; T_OVERLAY="#26233a"; T_MUTED="#6e6a86"
            T_BAT_THEME="base16"; T_DELTA_THEME="base16"
            T_IS_LIGHT=false
            ;;
        *)
            echo "Unknown theme: $theme"
            return 1
            ;;
    esac
}

# Save current settings to config file
save_settings() {
    mkdir -p "$DOTFILES_CONFIG_DIR"
    chmod 700 "$DOTFILES_CONFIG_DIR"
    cat > "$DOTFILES_CONFIG_DIR/settings" << EOF
# Dotfiles settings - do not edit manually, use 'dotfiles' command
THEME="$THEME"
NAV_STYLE="$NAV_STYLE"
EOF
    chmod 600 "$DOTFILES_CONFIG_DIR/settings"
}

# Load settings from config file
# Safe setting parser - extracts only known variables (no arbitrary code execution)
safe_read_setting() {
    local file="$1" key="$2" default="${3:-}"
    if [[ -f "$file" ]]; then
        local value
        value=$(grep -E "^${key}=" "$file" 2>/dev/null | head -1 | cut -d'=' -f2- | sed 's/^["'"'"']//;s/["'"'"']$//')
        echo "${value:-$default}"
    else
        echo "$default"
    fi
}

load_settings() {
    local settings_file="$DOTFILES_CONFIG_DIR/settings"
    THEME=$(safe_read_setting "$settings_file" "THEME" "catppuccin-mocha")
    NAV_STYLE=$(safe_read_setting "$settings_file" "NAV_STYLE" "emacs")
    ACTIVE_USER=$(safe_read_setting "$settings_file" "ACTIVE_USER" "")
}

# Generate Ghostty theme file
generate_ghostty_theme() {
    load_theme_colors
    mkdir -p ~/.config/ghostty/themes
    cat > ~/.config/ghostty/themes/dotfiles-theme << EOF
# Generated by dotfiles - Theme: $THEME

background = ${T_BG}
foreground = ${T_FG}
cursor-color = ${T_CURSOR}
cursor-text = ${T_CURSOR_TEXT}
selection-background = ${T_SEL_BG}
selection-foreground = ${T_SEL_FG}

palette = 0=${T_BLACK}
palette = 8=${T_BRIGHT_BLACK}
palette = 1=${T_RED}
palette = 9=${T_BRIGHT_RED}
palette = 2=${T_GREEN}
palette = 10=${T_BRIGHT_GREEN}
palette = 3=${T_YELLOW}
palette = 11=${T_BRIGHT_YELLOW}
palette = 4=${T_BLUE}
palette = 12=${T_BRIGHT_BLUE}
palette = 5=${T_MAGENTA}
palette = 13=${T_BRIGHT_MAGENTA}
palette = 6=${T_CYAN}
palette = 14=${T_BRIGHT_CYAN}
palette = 7=${T_WHITE}
palette = 15=${T_BRIGHT_WHITE}
EOF
}

# Generate fzf color config (for .zshrc)
generate_fzf_colors() {
    load_theme_colors
    local bg_opt="-1"
    [[ "$T_IS_LIGHT" == "true" ]] && bg_opt="-1"

    echo "export FZF_DEFAULT_OPTS=\"\$FZF_DEFAULT_OPTS \\
  --color=fg:${T_FG},bg:${bg_opt},hl:${T_ACCENT3} \\
  --color=fg+:${T_FG},bg+:${T_SURFACE},hl+:${T_ACCENT3} \\
  --color=info:${T_MAGENTA},prompt:${T_CYAN},pointer:${T_CURSOR} \\
  --color=marker:${T_CURSOR},spinner:${T_CURSOR},header:${T_CYAN} \\
  --prompt='  ' --pointer='▶' --marker='✓'\""
}

# Generate tmux theme config
generate_tmux_theme() {
    load_theme_colors
    cat << EOF
# Theme: $THEME (generated by dotfiles)
set -g status-style 'bg=${T_BG} fg=${T_FG}'
set -g status-left '#[fg=${T_BG},bg=${T_ACCENT},bold]  #S #[fg=${T_ACCENT},bg=${T_BG}]'
set -g status-right '#[fg=${T_OVERLAY}]#[fg=${T_FG},bg=${T_OVERLAY}] %H:%M #[fg=${T_ACCENT}]#[fg=${T_BG},bg=${T_ACCENT},bold] %d %b '

setw -g window-status-current-style 'fg=${T_BG} bg=${T_ACCENT2} bold'
setw -g window-status-current-format '#[fg=${T_BG},bg=${T_ACCENT2}]#[fg=${T_BG},bg=${T_ACCENT2}] #I  #W #[fg=${T_ACCENT2},bg=${T_BG}]'
setw -g window-status-style 'fg=${T_MUTED} bg=${T_BG}'
setw -g window-status-format '  #I  #W  '
setw -g window-status-separator ''

set -g pane-border-style 'fg=${T_OVERLAY}'
set -g pane-active-border-style 'fg=${T_ACCENT}'
set -g message-style 'bg=${T_YELLOW} fg=${T_BG} bold'
setw -g mode-style 'bg=${T_ACCENT3} fg=${T_BG} bold'
EOF
}

# Generate yazi theme
generate_yazi_theme() {
    load_theme_colors
    cat << EOF
# Theme: $THEME (generated by dotfiles)

[manager]
cwd = { fg = "${T_CYAN}" }
hovered = { fg = "${T_BG}", bg = "${T_ACCENT}" }
preview_hovered = { underline = true }

find_keyword = { fg = "${T_YELLOW}", bold = true, italic = true, underline = true }
find_position = { fg = "${T_ACCENT3}", bg = "reset", bold = true }

marker_copied = { fg = "${T_GREEN}", bg = "${T_GREEN}" }
marker_cut = { fg = "${T_ACCENT3}", bg = "${T_ACCENT3}" }
marker_marked = { fg = "${T_ACCENT}", bg = "${T_ACCENT}" }
marker_selected = { fg = "${T_YELLOW}", bg = "${T_YELLOW}" }

tab_active = { fg = "${T_BG}", bg = "${T_FG}" }
tab_inactive = { fg = "${T_FG}", bg = "${T_OVERLAY}" }

border_symbol = "│"
border_style = { fg = "${T_MUTED}" }

[status]
separator_open = ""
separator_close = ""
separator_style = { fg = "${T_OVERLAY}", bg = "${T_OVERLAY}" }

mode_normal = { fg = "${T_BG}", bg = "${T_ACCENT}", bold = true }
mode_select = { fg = "${T_BG}", bg = "${T_ACCENT2}", bold = true }

progress_label = { fg = "${T_FG}", bold = true }
progress_normal = { fg = "${T_ACCENT}", bg = "${T_OVERLAY}" }
progress_error = { fg = "${T_ACCENT3}", bg = "${T_OVERLAY}" }

permissions_t = { fg = "${T_ACCENT}" }
permissions_r = { fg = "${T_YELLOW}" }
permissions_w = { fg = "${T_ACCENT3}" }
permissions_x = { fg = "${T_GREEN}" }
permissions_s = { fg = "${T_MUTED}" }

[input]
border = { fg = "${T_ACCENT}" }
title = {}
value = {}
selected = { reversed = true }

[select]
border = { fg = "${T_ACCENT}" }
active = { fg = "${T_ACCENT3}", bold = true }
inactive = {}

[tasks]
border = { fg = "${T_ACCENT}" }
title = {}
hovered = { fg = "${T_ACCENT3}", underline = true }

[which]
cols = 3
mask = { bg = "${T_SURFACE}" }
cand = { fg = "${T_CYAN}" }
rest = { fg = "${T_MUTED}" }
desc = { fg = "${T_ACCENT3}" }
separator = "  "
separator_style = { fg = "${T_OVERLAY}" }

[help]
on = { fg = "${T_CYAN}" }
run = { fg = "${T_ACCENT3}" }
desc = {}
hovered = { reversed = true, bold = true }
footer = { fg = "${T_OVERLAY}", bg = "${T_FG}" }

[filetype]
rules = [
  { mime = "image/*", fg = "${T_YELLOW}" },
  { mime = "video/*", fg = "${T_ACCENT3}" },
  { mime = "audio/*", fg = "${T_ACCENT3}" },
  { mime = "application/zip", fg = "${T_MAGENTA}" },
  { mime = "application/gzip", fg = "${T_MAGENTA}" },
  { mime = "application/x-tar", fg = "${T_MAGENTA}" },
  { mime = "application/pdf", fg = "${T_ACCENT3}" },
  { name = "*", fg = "${T_FG}" },
  { name = "*/", fg = "${T_ACCENT}" },
]
EOF
}

# Generate bat config
generate_bat_config() {
    load_theme_colors
    cat << EOF
--theme="${T_BAT_THEME}"
--style="numbers,changes,header"
--italic-text=always
--paging=auto
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help|help)
            cat << 'EOF'
dotfiles-setup - Cross-platform terminal environment setup

USAGE
    dotfiles-setup [options]

OPTIONS
    -h, --help          Show this help message
    -v, --version       Show version
    --emacs             Emacs/Mac-style navigation (default, beginner-friendly)
    --vim               Vim-style navigation (hjkl everywhere)
    --theme <name>      Color theme (default: catppuccin-mocha)
                        Themes: catppuccin-mocha, catppuccin-latte,
                        catppuccin-frappe, catppuccin-macchiato, dracula,
                        gruvbox-dark, gruvbox-light, nord, tokyo-night,
                        solarized-dark, solarized-light, monokai, rose-pine
    --macos-apps        Install optional macOS quality-of-life apps
    --raspi             Raspberry Pi mode (auto-detect model)
    --raspi5            Raspberry Pi 5 optimizations
    --raspizero2        Raspberry Pi Zero 2 optimizations (lightweight)
    -y, --yes           Skip confirmation prompts
    --restore [name]    Restore configs from backup (most recent if no name)
    --list-backups      List available backup sessions
    --no-backup         Skip creating backups (not recommended)

DESCRIPTION
    Sets up a complete terminal environment with Catppuccin Mocha theme.

    Installs and configures:
      • zsh with syntax highlighting & autosuggestions
      • tmux with powerline status bar
      • Ghostty terminal config (where available)
      • eza, yazi, zoxide, fzf, bat, delta
      • neovim (Kickstart.nvim)
      • Custom utilities: hk, caff, sshh

    Supports: macOS, Arch Linux, Debian/Ubuntu, Raspberry Pi OS

HOMEPAGE
    https://github.com/tekierz/dotfiles

EOF
            exit 0
            ;;
        -v|--version|version)
            echo "dotfiles-setup version $VERSION"
            exit 0
            ;;
        --macos-apps)
            INSTALL_MACOS_APPS=true
            shift
            ;;
        --raspi)
            RASPI_MODE=true
            shift
            ;;
        --raspi5)
            RASPI_MODE=true
            RASPI_MODEL="pi5"
            shift
            ;;
        --raspizero2)
            RASPI_MODE=true
            RASPI_MODEL="zero2"
            shift
            ;;
        -y|--yes)
            SKIP_PROMPTS=true
            shift
            ;;
        --no-backup)
            SKIP_BACKUP=true
            shift
            ;;
        --list-backups)
            # Defer to after functions are defined
            DO_LIST_BACKUPS=true
            shift
            ;;
        --restore)
            # Defer to after functions are defined
            DO_RESTORE=true
            if [[ -n "${2:-}" && ! "$2" =~ ^- ]]; then
                RESTORE_SESSION="$2"
                shift
            fi
            shift
            ;;
        --vim)
            NAV_STYLE="vim"
            shift
            ;;
        --emacs)
            NAV_STYLE="emacs"
            shift
            ;;
        --theme)
            if [[ -n "$2" && ! "$2" =~ ^- ]]; then
                THEME="$2"
                # Validate theme
                if [[ ! " $SUPPORTED_THEMES " =~ " $THEME " ]]; then
                    echo "Error: Unknown theme '$THEME'"
                    echo "Supported themes: $SUPPORTED_THEMES"
                    exit 1
                fi
                shift 2
            else
                echo "Error: --theme requires a theme name"
                echo "Supported themes: $SUPPORTED_THEMES"
                exit 1
            fi
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage"
            exit 1
            ;;
    esac
done

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_header() {
    echo -e "\n${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${PURPLE}  $1${NC}"
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

print_step() {
    echo -e "${CYAN}▶${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Cross-platform sed in-place (macOS requires -i '', Linux uses -i)
sed_i() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "$@"
    else
        sed -i "$@"
    fi
}

# Ask user yes/no question
ask_user() {
    if [[ "$SKIP_PROMPTS" == "true" ]]; then
        return 0
    fi
    local prompt="$1"
    local default="${2:-n}"
    local reply

    if [[ "$default" == "y" ]]; then
        echo -ne "${CYAN}?${NC} $prompt [Y/n]: "
    else
        echo -ne "${CYAN}?${NC} $prompt [y/N]: "
    fi
    read -r reply
    reply=${reply:-$default}
    [[ "$reply" =~ ^[Yy]$ ]]
}

# ============================================================================
# BACKUP SYSTEM
# ============================================================================
# All existing configs are backed up before modification, enabling full restore

# Initialize backup session - creates timestamped backup directory
init_backup_session() {
    local timestamp
    timestamp=$(date +%Y%m%d_%H%M%S)
    BACKUP_SESSION_DIR="$DOTFILES_BACKUP_DIR/$timestamp"
    BACKUP_MANIFEST="$BACKUP_SESSION_DIR/manifest.txt"

    mkdir -p "$BACKUP_SESSION_DIR"
    chmod 700 "$BACKUP_SESSION_DIR"

    # Write manifest header
    cat > "$BACKUP_MANIFEST" << EOF
# Dotfiles Backup Manifest
# Created: $(date)
# Version: $VERSION
# OS: $OS
# Theme: $THEME
# Navigation: $NAV_STYLE
#
# Format: original_path|backup_path|existed_before
EOF
    chmod 600 "$BACKUP_MANIFEST"

    print_success "Backup session initialized: $BACKUP_SESSION_DIR"
}

# Backup a single file before modification
# Usage: backup_file "/path/to/file"
# Returns: 0 if file existed and was backed up, 1 if file didn't exist
backup_file() {
    local original="$1"
    local relative_path="${original#$HOME/}"
    local backup_path="$BACKUP_SESSION_DIR/$relative_path"

    if [[ -f "$original" ]]; then
        # Create directory structure in backup
        mkdir -p "$(dirname "$backup_path")"
        cp -p "$original" "$backup_path"
        echo "$original|$backup_path|yes" >> "$BACKUP_MANIFEST"
        return 0
    else
        # Record that file didn't exist (for clean uninstall)
        echo "$original||no" >> "$BACKUP_MANIFEST"
        return 1
    fi
}

# Backup a directory before modification
# Usage: backup_directory "/path/to/dir"
backup_directory() {
    local original="$1"
    local relative_path="${original#$HOME/}"
    local backup_path="$BACKUP_SESSION_DIR/$relative_path"

    if [[ -d "$original" ]]; then
        mkdir -p "$(dirname "$backup_path")"
        cp -rp "$original" "$backup_path"
        echo "$original|$backup_path|yes|directory" >> "$BACKUP_MANIFEST"
        return 0
    else
        echo "$original||no|directory" >> "$BACKUP_MANIFEST"
        return 1
    fi
}

# Safe write - backs up existing file before writing new content
# Usage: safe_write_config "path" "content" "description"
safe_write_config() {
    local file="$1"
    local content="$2"
    local description="${3:-config}"

    # Backup existing file if it exists
    if [[ -n "$BACKUP_SESSION_DIR" ]]; then
        backup_file "$file"
    fi

    # Create directory and write file
    mkdir -p "$(dirname "$file")"
    echo "$content" > "$file"
    print_success "Created $description"
}

# List available backup sessions
list_backups() {
    echo -e "${BLUE}Available Backups:${NC}"
    if [[ ! -d "$DOTFILES_BACKUP_DIR" ]]; then
        echo "  No backups found"
        return
    fi

    local count=0
    for backup in "$DOTFILES_BACKUP_DIR"/*/; do
        [[ -d "$backup" ]] || continue
        local name=$(basename "$backup")
        local manifest="$backup/manifest.txt"
        if [[ -f "$manifest" ]]; then
            local files=$(grep -c "|yes" "$manifest" 2>/dev/null || echo "0")
            echo -e "  ${CYAN}$name${NC} - $files files backed up"
            ((count++))
        fi
    done

    if [[ $count -eq 0 ]]; then
        echo "  No backups found"
    fi
}

# Restore from a backup session
# Usage: restore_backup [session_name]
restore_backup() {
    local session="${1:-}"

    if [[ -z "$session" ]]; then
        # Find most recent backup
        session=$(ls -1t "$DOTFILES_BACKUP_DIR" 2>/dev/null | head -1)
        if [[ -z "$session" ]]; then
            print_error "No backups found"
            return 1
        fi
        echo -e "Using most recent backup: ${CYAN}$session${NC}"
    fi

    local backup_dir="$DOTFILES_BACKUP_DIR/$session"
    local manifest="$backup_dir/manifest.txt"

    if [[ ! -f "$manifest" ]]; then
        print_error "Backup not found: $session"
        return 1
    fi

    echo -e "${YELLOW}This will restore your configs to the state before dotfiles-setup was run.${NC}"
    echo -e "${YELLOW}Files created by dotfiles-setup will be removed.${NC}"
    if ! ask_user "Continue with restore?" "n"; then
        echo "Restore cancelled."
        return 1
    fi

    local restored=0
    local removed=0
    local errors=0

    while IFS='|' read -r original backup existed type || [[ -n "$original" ]]; do
        # Skip comments and empty lines
        [[ "$original" =~ ^# ]] && continue
        [[ -z "$original" ]] && continue

        if [[ "$existed" == "yes" ]]; then
            # File existed before - restore it
            if [[ "$type" == "directory" ]]; then
                if [[ -d "$backup" ]]; then
                    rm -rf "$original" 2>/dev/null
                    cp -rp "$backup" "$original" && ((restored++)) || ((errors++))
                fi
            else
                if [[ -f "$backup" ]]; then
                    mkdir -p "$(dirname "$original")"
                    cp -p "$backup" "$original" && ((restored++)) || ((errors++))
                fi
            fi
        else
            # File didn't exist before - remove it
            if [[ "$type" == "directory" ]]; then
                [[ -d "$original" ]] && rm -rf "$original" && ((removed++))
            else
                [[ -f "$original" ]] && rm -f "$original" && ((removed++))
            fi
        fi
    done < "$manifest"

    print_success "Restore complete: $restored files restored, $removed files removed, $errors errors"

    if [[ $errors -gt 0 ]]; then
        print_warning "Some files could not be restored. Check permissions."
    fi

    echo -e "\nRestart your terminal for changes to take effect."
}

# Detect OS
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
    elif [[ -f /etc/arch-release ]] || [[ -f /etc/cachyos-release ]]; then
        OS="arch"
    elif [[ -f /etc/debian_version ]]; then
        # Check if it's a Raspberry Pi
        if [[ -f /proc/device-tree/model ]] && grep -q "Raspberry Pi" /proc/device-tree/model 2>/dev/null; then
            OS="raspi"
            # Auto-detect Pi model if not specified
            if [[ -z "$RASPI_MODEL" ]]; then
                if grep -q "Pi 5" /proc/device-tree/model 2>/dev/null; then
                    RASPI_MODEL="pi5"
                elif grep -q "Zero 2" /proc/device-tree/model 2>/dev/null; then
                    RASPI_MODEL="zero2"
                elif grep -q "Pi 4" /proc/device-tree/model 2>/dev/null; then
                    RASPI_MODEL="pi4"
                else
                    RASPI_MODEL="generic"
                fi
            fi
        else
            OS="debian"
        fi
    else
        OS="unknown"
    fi
    echo "$OS"
}

# Override OS if raspi mode is forced
if [[ "$RASPI_MODE" == "true" ]]; then
    OS="raspi"
else
    OS=$(detect_os)
fi

# Handle --list-backups and --restore before main setup
if [[ "$DO_LIST_BACKUPS" == "true" ]]; then
    list_backups
    exit 0
fi

if [[ "$DO_RESTORE" == "true" ]]; then
    restore_backup "$RESTORE_SESSION"
    exit $?
fi

print_header "Dotfiles Setup (Catppuccin Mocha Theme)"
echo -e "Detected OS: ${CYAN}$OS${NC}"
[[ "$OS" == "raspi" ]] && echo -e "Raspberry Pi Model: ${CYAN}${RASPI_MODEL}${NC}"
echo -e "Navigation Style: ${CYAN}$NAV_STYLE${NC} (use --vim or --emacs to change)"
echo -e "Theme: ${PURPLE}$THEME${NC} (use --theme <name> to change)"
echo ""

# ============================================================================
# PACKAGE INSTALLATION
# ============================================================================

install_packages() {
    print_header "Installing Packages"

    if [[ "$OS" == "macos" ]]; then
        # Install Homebrew if not present
        if ! command -v brew &> /dev/null; then
            print_step "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

            # Add to path for this session
            eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)"
            print_success "Homebrew installed"
        else
            print_success "Homebrew already installed"
        fi

        print_step "Installing packages via Homebrew..."
        brew install \
            zsh \
            zsh-syntax-highlighting \
            zsh-autosuggestions \
            eza \
            yazi \
            zoxide \
            fzf \
            bat \
            ripgrep \
            fd \
            git-delta \
            btop \
            fastfetch \
            tmux \
            neovim \
            tlrc \
            powerlevel10k \
            ncdu \
            duf \
            dust \
            bandwhich \
            gping \
            dog \
            trippy \
            2>/dev/null || true

        # Install fonts
        print_step "Installing Nerd Fonts..."
        brew tap homebrew/cask-fonts 2>/dev/null || true
        brew install --cask font-jetbrains-mono-nerd-font font-iosevka-nerd-font 2>/dev/null || true

        # Install Ghostty if available
        print_step "Installing Ghostty..."
        brew install --cask ghostty 2>/dev/null || print_warning "Ghostty not available via brew, install manually"

        # macOS system monitor (macmon)
        print_step "Installing macmon..."
        brew install macmon 2>/dev/null || print_warning "macmon not available"

        # Optional macOS Quality of Life Apps
        if [[ "$INSTALL_MACOS_APPS" == "true" ]] || ask_user "Install optional macOS quality-of-life apps? (Rectangle, Raycast, Stats, etc.)"; then
            print_step "Installing macOS quality-of-life apps..."

            # Essential (always install)
            brew install --cask \
                rectangle \
                raycast \
                stats \
                2>/dev/null || true

            # Optional (prompt individually if not using --macos-apps flag)
            if [[ "$INSTALL_MACOS_APPS" == "true" ]] || [[ "$SKIP_PROMPTS" == "true" ]]; then
                brew install --cask \
                    alt-tab \
                    monitorcontrol \
                    mos \
                    karabiner-elements \
                    iina \
                    the-unarchiver \
                    appcleaner \
                    2>/dev/null || true

                brew install \
                    mas \
                    trash \
                    switchaudio-osx \
                    2>/dev/null || true
            else
                # Ask for each optional app
                ask_user "Install AltTab (Windows-style alt-tab)?" && brew install --cask alt-tab 2>/dev/null || true
                ask_user "Install MonitorControl (external monitor brightness)?" && brew install --cask monitorcontrol 2>/dev/null || true
                ask_user "Install Mos (smooth scrolling for mouse)?" && brew install --cask mos 2>/dev/null || true
                ask_user "Install Karabiner-Elements (keyboard customization)?" && brew install --cask karabiner-elements 2>/dev/null || true
                ask_user "Install IINA (modern video player)?" && brew install --cask iina 2>/dev/null || true
                ask_user "Install The Unarchiver?" && brew install --cask the-unarchiver 2>/dev/null || true
                ask_user "Install AppCleaner?" && brew install --cask appcleaner 2>/dev/null || true
                ask_user "Install mas (Mac App Store CLI)?" && brew install mas 2>/dev/null || true
                ask_user "Install trash (CLI trash command)?" && brew install trash 2>/dev/null || true
            fi

            print_success "macOS apps installed"
        else
            print_warning "Skipped macOS apps (use --macos-apps to install)"
        fi

    elif [[ "$OS" == "raspi" ]]; then
        print_step "Installing packages for Raspberry Pi..."

        # Base packages for all Pi models
        sudo apt update
        sudo apt install -y \
            zsh \
            tmux \
            neovim \
            fzf \
            bat \
            ripgrep \
            fd-find \
            git \
            curl \
            wget \
            htop \
            xclip \
            2>/dev/null || true

        # Model-specific optimizations
        if [[ "$RASPI_MODEL" == "zero2" ]]; then
            print_step "Applying Raspberry Pi Zero 2 optimizations (lightweight)..."
            # Skip heavy tools for Zero 2
            print_warning "Skipping yazi, btop (too heavy for Zero 2)"
        else
            # Pi 4/5 can handle more
            print_step "Installing additional tools for Pi ${RASPI_MODEL}..."
            sudo apt install -y \
                btop \
                2>/dev/null || true
        fi

        # Install from source/binary for tools not in apt
        print_step "Installing modern CLI tools..."

        # eza (modern ls)
        if ! command -v eza &> /dev/null; then
            if [[ "$RASPI_MODEL" != "zero2" ]]; then
                print_step "Installing eza..."
                sudo apt install -y eza 2>/dev/null || \
                    cargo install eza 2>/dev/null || \
                    print_warning "Could not install eza"
            fi
        fi

        # zoxide
        if ! command -v zoxide &> /dev/null; then
            print_step "Installing zoxide..."
            curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash 2>/dev/null || \
                print_warning "Could not install zoxide"
        fi

        # yazi (skip on Zero 2)
        if [[ "$RASPI_MODEL" != "zero2" ]] && ! command -v yazi &> /dev/null; then
            print_step "Installing yazi..."
            cargo install --locked yazi-fm 2>/dev/null || \
                print_warning "Could not install yazi (requires cargo)"
        fi

        # delta
        if ! command -v delta &> /dev/null; then
            print_step "Installing delta..."
            cargo install git-delta 2>/dev/null || \
                print_warning "Could not install delta"
        fi

        # Pi-specific: install zsh plugins manually
        print_step "Installing zsh plugins..."
        ZSH_PLUGINS_DIR="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins"
        mkdir -p "$ZSH_PLUGINS_DIR"

        if [[ ! -d "$ZSH_PLUGINS_DIR/zsh-syntax-highlighting" ]]; then
            git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_PLUGINS_DIR/zsh-syntax-highlighting" 2>/dev/null || true
        fi
        if [[ ! -d "$ZSH_PLUGINS_DIR/zsh-autosuggestions" ]]; then
            git clone https://github.com/zsh-users/zsh-autosuggestions.git "$ZSH_PLUGINS_DIR/zsh-autosuggestions" 2>/dev/null || true
        fi

        print_success "Raspberry Pi packages installed"

    elif [[ "$OS" == "arch" ]]; then
        print_step "Installing packages via pacman..."
        sudo pacman -S --needed --noconfirm \
            zsh \
            zsh-syntax-highlighting \
            zsh-autosuggestions \
            eza \
            yazi \
            zoxide \
            fzf \
            bat \
            ripgrep \
            fd \
            git-delta \
            btop \
            fastfetch \
            tmux \
            neovim \
            ttf-jetbrains-mono-nerd \
            pacman-contrib \
            wl-clipboard \
            xclip \
            ncdu \
            duf \
            bandwhich \
            gping \
            2>/dev/null || true

        # Enable paccache timer
        sudo systemctl enable --now paccache.timer 2>/dev/null || true

        # Install paru packages
        if command -v paru &> /dev/null; then
            print_step "Installing AUR packages..."
            paru -S --needed --noconfirm \
                ghostty \
                dust \
                dog \
                trippy \
                2>/dev/null || true
        fi

    elif [[ "$OS" == "debian" ]]; then
        print_step "Installing packages via apt..."
        sudo apt update
        sudo apt install -y \
            zsh \
            tmux \
            neovim \
            fzf \
            bat \
            ripgrep \
            fd-find \
            btop \
            xclip \
            wl-clipboard \
            ncdu \
            2>/dev/null || true

        # Install duf if available (Ubuntu 22.04+)
        sudo apt install -y duf 2>/dev/null || true

        print_warning "Some packages may need manual installation on Debian/Ubuntu"
        print_warning "Consider using Homebrew for: eza, yazi, zoxide, delta, fastfetch"
        print_warning "Network tools (bandwhich, gping, dog, trippy) require cargo or Homebrew"
    fi

    print_success "Package installation complete"
}

# ============================================================================
# DIRECTORY SETUP
# ============================================================================

setup_directories() {
    print_header "Setting Up Directories"

    mkdir -p ~/.config/ghostty/themes
    mkdir -p ~/.config/yazi
    mkdir -p ~/.config/bat
    mkdir -p ~/.config/nvim
    mkdir -p ~/.local/bin

    print_success "Directories created"
}

# ============================================================================
# ZSH CONFIGURATION
# ============================================================================

setup_zsh() {
    print_header "Configuring Zsh"

    # Backup existing zshrc
    [[ -n "${BACKUP_SESSION_DIR:-}" ]] && backup_file "$HOME/.zshrc"

    # Determine plugin paths based on OS
    if [[ "$OS" == "macos" ]]; then
        SYNTAX_HL_PATH="/opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
        AUTOSUGG_PATH="/opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
        FZF_KEYBIND_PATH="/opt/homebrew/opt/fzf/shell/key-bindings.zsh"
        FZF_COMPLETION_PATH="/opt/homebrew/opt/fzf/shell/completion.zsh"
        P10K_PATH="/opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme"

        # Intel Mac fallback
        if [[ ! -f "$SYNTAX_HL_PATH" ]]; then
            SYNTAX_HL_PATH="/usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
            AUTOSUGG_PATH="/usr/local/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
            FZF_KEYBIND_PATH="/usr/local/opt/fzf/shell/key-bindings.zsh"
            FZF_COMPLETION_PATH="/usr/local/opt/fzf/shell/completion.zsh"
            P10K_PATH="/usr/local/share/powerlevel10k/powerlevel10k.zsh-theme"
        fi
    else
        SYNTAX_HL_PATH="/usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
        AUTOSUGG_PATH="/usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"
        FZF_KEYBIND_PATH="/usr/share/fzf/key-bindings.zsh"
        FZF_COMPLETION_PATH="/usr/share/fzf/completion.zsh"
        P10K_PATH=""
    fi

    cat > ~/.zshrc << 'ZSHRC_EOF'
# System info on new shell
command -v fastfetch &> /dev/null && fastfetch

# Enable Powerlevel10k instant prompt
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Powerlevel10k theme (macOS)
[[ -f /opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme ]] && \
  source /opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme
[[ -f /usr/local/share/powerlevel10k/powerlevel10k.zsh-theme ]] && \
  source /usr/local/share/powerlevel10k/powerlevel10k.zsh-theme

# CachyOS config (Linux)
[[ -f /usr/share/cachyos-zsh-config/cachyos-config.zsh ]] && \
  source /usr/share/cachyos-zsh-config/cachyos-config.zsh

# PATH additions
export PATH="$HOME/.local/bin:$PATH"

# Homebrew (macOS)
[[ -d /opt/homebrew ]] && eval "$(/opt/homebrew/bin/brew shellenv)"
[[ -d /usr/local/Homebrew ]] && eval "$(/usr/local/bin/brew shellenv)"

# Linuxbrew
[[ -d /home/linuxbrew/.linuxbrew ]] && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# eza aliases (modern ls replacement)
if command -v eza &> /dev/null; then
  alias ls='eza --icons --group-directories-first'
  alias ll='eza -l --icons --group-directories-first --git'
  alias la='eza -la --icons --group-directories-first --git'
  alias lt='eza --tree --level=2 --icons --group-directories-first'
  alias lta='eza --tree --level=2 -a --icons --group-directories-first'
fi

# Disk usage tools
command -v duf &> /dev/null && alias df='duf'
command -v dust &> /dev/null && alias du='dust'
command -v ncdu &> /dev/null && alias diskuse='ncdu'

# Network tools
command -v bandwhich &> /dev/null && alias bandwidth='bandwhich'
command -v gping &> /dev/null && alias ping='gping'
command -v dog &> /dev/null && alias dig='dog'
command -v trippy &> /dev/null && alias trace='trip'

# zoxide (smarter cd)
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh)"
  alias cd='z'
fi

# yazi file manager (y or yazi to open, q exits to dir, Q exits without cd)
function y() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
  command yazi "$@" --cwd-file="$tmp"
  if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd "$cwd" || z "$cwd" 2>/dev/null
  fi
  rm -f -- "$tmp"
}
alias yazi='y'

# fzf (fuzzy finder)
[[ -f /usr/share/fzf/key-bindings.zsh ]] && source /usr/share/fzf/key-bindings.zsh
[[ -f /usr/share/fzf/completion.zsh ]] && source /usr/share/fzf/completion.zsh
[[ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]] && source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
[[ -f /opt/homebrew/opt/fzf/shell/completion.zsh ]] && source /opt/homebrew/opt/fzf/shell/completion.zsh
[[ -f /usr/local/opt/fzf/shell/key-bindings.zsh ]] && source /usr/local/opt/fzf/shell/key-bindings.zsh
[[ -f /usr/local/opt/fzf/shell/completion.zsh ]] && source /usr/local/opt/fzf/shell/completion.zsh

export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border'
if command -v fd &> /dev/null; then
  export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
fi

# fzf colors (set by dotfiles - do not edit, use 'dotfiles theme' to change)
# FZF_COLORS_PLACEHOLDER

# Preview files with bat in fzf
if command -v bat &> /dev/null; then
  export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:500 {}'"
fi

# Colorful man pages
export LESS_TERMCAP_mb=$'\e[1;32m'
export LESS_TERMCAP_md=$'\e[1;32m'
export LESS_TERMCAP_me=$'\e[0m'
export LESS_TERMCAP_se=$'\e[0m'
export LESS_TERMCAP_so=$'\e[01;33m'
export LESS_TERMCAP_ue=$'\e[0m'
export LESS_TERMCAP_us=$'\e[1;4;31m'

# Zsh syntax highlighting & autosuggestions
[[ -f /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && \
  source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
[[ -f /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]] && \
  source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
[[ -f /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && \
  source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
[[ -f /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]] && \
  source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
[[ -f /usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && \
  source /usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
[[ -f /usr/local/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]] && \
  source /usr/local/share/zsh-autosuggestions/zsh-autosuggestions.zsh

# Autosuggestion style
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=244'
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
bindkey '^f' autosuggest-accept

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh
ZSHRC_EOF

    # Add navigation-style specific keybindings
    if [[ "$NAV_STYLE" == "vim" ]]; then
        cat >> ~/.zshrc << 'ZSHRC_VIM_EOF'

# Vim keybindings
bindkey -v
export KEYTIMEOUT=1

# Better vim mode experience
bindkey '^P' up-history
bindkey '^N' down-history
bindkey '^?' backward-delete-char
bindkey '^h' backward-delete-char
bindkey '^w' backward-kill-word

# Edit command in nvim with Ctrl-e
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^e' edit-command-line
ZSHRC_VIM_EOF
    else
        cat >> ~/.zshrc << 'ZSHRC_EMACS_EOF'

# Emacs keybindings (Mac-style navigation)
bindkey -e

# Edit command in nvim with Ctrl-x Ctrl-e
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^x^e' edit-command-line
ZSHRC_EMACS_EOF
    fi

    # Replace FZF colors placeholder with theme-specific colors
    local fzf_colors
    fzf_colors=$(generate_fzf_colors)
    sed_i "s|# FZF_COLORS_PLACEHOLDER|$fzf_colors|" ~/.zshrc

    print_success "Zsh configured ($NAV_STYLE navigation, $THEME theme)"
}

# ============================================================================
# TMUX CONFIGURATION
# ============================================================================

setup_tmux() {
    print_header "Configuring Tmux"

    # Backup existing tmux.conf
    [[ -n "${BACKUP_SESSION_DIR:-}" ]] && backup_file "$HOME/.tmux.conf"

    # Base tmux config (common to both navigation styles)
    cat > ~/.tmux.conf << 'TMUX_EOF'
# Terminal settings
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# Use Ctrl-a instead of Ctrl-b (easier to reach)
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# Split panes with | and - (more intuitive)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# New windows open in current path
bind c new-window -c "#{pane_current_path}"

# Enable mouse
set -g mouse on

# Start window/pane numbering at 1
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Faster escape time (important for nvim)
set -sg escape-time 0

# Increase scrollback buffer
set -g history-limit 50000

# Reload config with r
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Quick window switching (Alt + number, no prefix needed)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# Status bar position and lengths
set -g status-position top
set -g status-left-length 30
set -g status-right-length 50

# Clipboard integration (cross-platform)
# Detects: pbcopy (macOS), wl-copy (Wayland), xclip (X11)

# Mouse selection copies to system clipboard
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel \
    'sh -c "command -v pbcopy >/dev/null && pbcopy || ([ \"\$XDG_SESSION_TYPE\" = wayland ] && wl-copy || xclip -sel clip)"'
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel \
    'sh -c "command -v pbcopy >/dev/null && pbcopy || ([ \"\$XDG_SESSION_TYPE\" = wayland ] && wl-copy || xclip -sel clip)"'

# M-w (emacs) / y (vim) copies to system clipboard in copy mode
bind -T copy-mode M-w send-keys -X copy-pipe-and-cancel \
    'sh -c "command -v pbcopy >/dev/null && pbcopy || ([ \"\$XDG_SESSION_TYPE\" = wayland ] && wl-copy || xclip -sel clip)"'
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel \
    'sh -c "command -v pbcopy >/dev/null && pbcopy || ([ \"\$XDG_SESSION_TYPE\" = wayland ] && wl-copy || xclip -sel clip)"'

# Middle mouse pastes from system clipboard
bind -n MouseDown2Pane run \
    'sh -c "(command -v pbpaste >/dev/null && pbpaste || ([ \"\$XDG_SESSION_TYPE\" = wayland ] && wl-paste || xclip -sel clip -o)) | tmux load-buffer - && tmux paste-buffer"'
TMUX_EOF

    # Add theme colors
    generate_tmux_theme >> ~/.tmux.conf

    # Add navigation-style specific bindings
    if [[ "$NAV_STYLE" == "vim" ]]; then
        cat >> ~/.tmux.conf << 'TMUX_VIM_EOF'

# Vim-style pane navigation (hjkl)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Vim-style pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Alt + hjkl pane navigation (no prefix needed)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Vi mode for copy mode
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
TMUX_VIM_EOF
    else
        cat >> ~/.tmux.conf << 'TMUX_EMACS_EOF'

# Arrow key pane navigation (with prefix)
bind Left select-pane -L
bind Down select-pane -D
bind Up select-pane -U
bind Right select-pane -R

# Arrow key pane resizing
bind -r S-Left resize-pane -L 5
bind -r S-Down resize-pane -D 5
bind -r S-Up resize-pane -U 5
bind -r S-Right resize-pane -R 5

# Alt + arrow pane navigation (no prefix needed)
bind -n M-Left select-pane -L
bind -n M-Down select-pane -D
bind -n M-Up select-pane -U
bind -n M-Right select-pane -R

# Emacs mode for copy mode
setw -g mode-keys emacs
TMUX_EMACS_EOF
    fi

    print_success "Tmux configured ($NAV_STYLE navigation)"
}

# ============================================================================
# GHOSTTY CONFIGURATION
# ============================================================================

setup_ghostty() {
    print_header "Configuring Ghostty"

    # Backup existing ghostty config
    [[ -n "${BACKUP_SESSION_DIR:-}" ]] && {
        backup_file "$HOME/.config/ghostty/config"
        backup_directory "$HOME/.config/ghostty/themes"
    }

    mkdir -p ~/.config/ghostty/themes

    cat > ~/.config/ghostty/config << 'GHOSTTY_EOF'
font-family = JetBrainsMono Nerd Font
font-size = 13

# Theme (managed by dotfiles command)
theme = dotfiles-theme

background-opacity = 0.9

window-padding-x = 8
window-padding-y = 8

cursor-style = block
cursor-style-blink = false
mouse-hide-while-typing = true

confirm-close-surface = false
window-save-state = always

shell-integration = detect

clipboard-read = ask
clipboard-write = allow
clipboard-paste-protection = true

scrollback-limit = 67108864

# Shift+Enter for newlines in Claude Code
keybind = shift+enter=text:\n

# Tab navigation
keybind = ctrl+shift+left_bracket=previous_tab
keybind = ctrl+shift+right_bracket=next_tab
GHOSTTY_EOF

    # Generate theme file based on selected theme
    generate_ghostty_theme

    print_success "Ghostty configured"
}

# ============================================================================
# DESKTOP ENVIRONMENT SHORTCUTS
# ============================================================================
# Free up Super+C/V/1-9 for Ghostty by remapping DE shortcuts
# This makes Cmd key behave like macOS when using a Mac keyboard on Linux

setup_de_shortcuts() {
    print_header "Configuring Desktop Environment Shortcuts"

    # Detect desktop environment
    local de="${XDG_CURRENT_DESKTOP:-}"
    de="${de,,}"  # lowercase

    # Also check session type
    local session="${XDG_SESSION_DESKTOP:-}"
    session="${session,,}"

    # Detect by checking for running processes or config tools
    if [[ -z "$de" ]]; then
        if command -v kwriteconfig6 &>/dev/null || command -v kwriteconfig5 &>/dev/null; then
            de="kde"
        elif command -v gsettings &>/dev/null && gsettings list-schemas 2>/dev/null | grep -q "org.gnome"; then
            de="gnome"
        elif command -v xfconf-query &>/dev/null; then
            de="xfce"
        fi
    fi

    case "$de" in
        *kde*|*plasma*)
            setup_kde_shortcuts
            ;;
        *gnome*|*ubuntu*)
            setup_gnome_shortcuts
            ;;
        *xfce*)
            setup_xfce_shortcuts
            ;;
        *lxde*|*lxqt*|*pixel*)
            print_warning "LXDE/LXQt detected - shortcuts usually don't conflict with Super+key"
            ;;
        *)
            if [[ -z "$de" ]]; then
                print_warning "No desktop environment detected (headless server?) - skipping DE shortcuts"
            else
                print_warning "Unknown desktop environment: $de - skipping shortcut configuration"
            fi
            return 0
            ;;
    esac
}

setup_kde_shortcuts() {
    print_step "Configuring KDE Plasma shortcuts..."

    # Find the right kwriteconfig command (KDE 5 vs 6)
    local kwrite=""
    if command -v kwriteconfig6 &>/dev/null; then
        kwrite="kwriteconfig6"
    elif command -v kwriteconfig5 &>/dev/null; then
        kwrite="kwriteconfig5"
    else
        print_warning "kwriteconfig not found - configure shortcuts manually in System Settings"
        return 1
    fi

    # Remap clipboard manager from Meta+V to Alt+V
    $kwrite --file kglobalshortcutsrc --group org.kde.klipper \
        --key "show-on-mouse-pos" "Alt+V,Meta+V,Show Clipboard Items at Mouse Position" 2>/dev/null

    # Disable Meta+1-9 task manager shortcuts (frees them for Ghostty tabs)
    for i in {1..9}; do
        $kwrite --file kglobalshortcutsrc --group plasmashell \
            --key "activate task manager entry $i" "none,Meta+$i,Activate Task Manager Entry $i" 2>/dev/null
    done

    # Try to reload shortcuts
    if command -v qdbus &>/dev/null; then
        qdbus org.kde.kglobalaccel /kglobalaccel reloadConfig 2>/dev/null || true
    fi

    print_success "KDE shortcuts configured"
    print_warning "Log out/in for shortcuts to fully take effect"
}

setup_gnome_shortcuts() {
    print_step "Configuring GNOME shortcuts..."

    # GNOME doesn't use Super+V or Super+1-9 by default, but Ubuntu might
    # Check for any conflicts

    # Disable Super+number workspace switching if set
    for i in {1..9}; do
        gsettings set org.gnome.shell.keybindings switch-to-application-$i "[]" 2>/dev/null || true
    done

    # Disable Super+V if it's bound to something
    gsettings set org.gnome.shell.keybindings toggle-message-tray "['<Super>m']" 2>/dev/null || true

    print_success "GNOME shortcuts configured"
}

setup_xfce_shortcuts() {
    print_step "Configuring XFCE shortcuts..."

    # XFCE uses xfconf for settings
    # Usually doesn't have many Super+key conflicts by default

    # Check and clear any Super+1-9 bindings
    for i in {1..9}; do
        xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/<Super>$i" -r 2>/dev/null || true
        xfconf-query -c xfce4-keyboard-shortcuts -p "/xfwm4/custom/<Super>$i" -r 2>/dev/null || true
    done

    print_success "XFCE shortcuts configured"
}

# ============================================================================
# YAZI CONFIGURATION
# ============================================================================

setup_yazi() {
    print_header "Configuring Yazi"

    # Backup existing yazi config directory
    [[ -n "${BACKUP_SESSION_DIR:-}" ]] && backup_directory "$HOME/.config/yazi"

    mkdir -p ~/.config/yazi

    cat > ~/.config/yazi/yazi.toml << 'YAZI_EOF'
[manager]
ratio = [1, 3, 4]
sort_by = "natural"
sort_dir_first = true
show_hidden = false
show_symlink = true

[preview]
tab_size = 2
max_width = 1000
max_height = 1000

[opener]
edit = [
  { run = 'nvim "$@"', block = true, for = "unix" },
]

[open]
rules = [
  { mime = "text/*", use = "edit" },
  { mime = "application/json", use = "edit" },
  { mime = "application/x-yaml", use = "edit" },
]
YAZI_EOF

    # Write keymap based on navigation style
    if [[ "$NAV_STYLE" == "vim" ]]; then
        cat > ~/.config/yazi/keymap.toml << 'KEYMAP_VIM_EOF'
[manager]
keymap = [
  { on = ["<Esc>"], run = "escape", desc = "Exit visual mode" },
  { on = ["q"], run = "quit", desc = "Quit" },
  { on = ["Q"], run = "quit --no-cwd-file", desc = "Quit without cd" },

  # Navigation (vim-style)
  { on = ["k"], run = "arrow -1", desc = "Move up" },
  { on = ["j"], run = "arrow 1", desc = "Move down" },
  { on = ["K"], run = "arrow -5", desc = "Move up 5" },
  { on = ["J"], run = "arrow 5", desc = "Move down 5" },
  { on = ["h"], run = "leave", desc = "Go to parent" },
  { on = ["l"], run = "enter", desc = "Enter directory" },
  { on = ["<C-u>"], run = "arrow -50%", desc = "Half page up" },
  { on = ["<C-d>"], run = "arrow 50%", desc = "Half page down" },

  { on = ["g", "g"], run = "arrow -99999999", desc = "Go to top" },
  { on = ["G"], run = "arrow 99999999", desc = "Go to bottom" },

  # Selection
  { on = ["<Space>"], run = ["select --state=none", "arrow 1"], desc = "Toggle select" },
  { on = ["v"], run = "visual_mode", desc = "Visual mode" },

  # Operations
  { on = ["o"], run = "open", desc = "Open" },
  { on = ["<Enter>"], run = "open", desc = "Open" },
  { on = ["y"], run = "yank", desc = "Yank" },
  { on = ["x"], run = "yank --cut", desc = "Cut" },
  { on = ["p"], run = "paste", desc = "Paste" },
  { on = ["d"], run = "remove", desc = "Trash" },
  { on = ["D"], run = "remove --permanently", desc = "Delete" },
  { on = ["a"], run = "create", desc = "Create" },
  { on = ["r"], run = "rename --cursor=before_ext", desc = "Rename" },

  # Find
  { on = ["/"], run = "find --smart", desc = "Find" },
  { on = ["n"], run = "find_arrow", desc = "Next match" },
  { on = ["N"], run = "find_arrow --previous", desc = "Prev match" },
  { on = ["f"], run = "filter --smart", desc = "Filter" },

  # Goto
  { on = ["g", "h"], run = "cd ~", desc = "Go home" },
  { on = ["g", "c"], run = "cd ~/.config", desc = "Go config" },
  { on = ["g", "d"], run = "cd ~/Downloads", desc = "Go downloads" },

  # Toggle
  { on = ["."], run = "hidden toggle", desc = "Toggle hidden" },
]
KEYMAP_VIM_EOF
    else
        cat > ~/.config/yazi/keymap.toml << 'KEYMAP_EMACS_EOF'
[manager]
keymap = [
  { on = ["<Esc>"], run = "escape", desc = "Exit visual mode" },
  { on = ["q"], run = "quit", desc = "Quit" },
  { on = ["Q"], run = "quit --no-cwd-file", desc = "Quit without cd" },

  # Navigation (arrow keys)
  { on = ["<Up>"], run = "arrow -1", desc = "Move up" },
  { on = ["<Down>"], run = "arrow 1", desc = "Move down" },
  { on = ["<S-Up>"], run = "arrow -5", desc = "Move up 5" },
  { on = ["<S-Down>"], run = "arrow 5", desc = "Move down 5" },
  { on = ["<Left>"], run = "leave", desc = "Go to parent" },
  { on = ["<Right>"], run = "enter", desc = "Enter directory" },
  { on = ["<PageUp>"], run = "arrow -50%", desc = "Half page up" },
  { on = ["<PageDown>"], run = "arrow 50%", desc = "Half page down" },
  { on = ["<Home>"], run = "arrow -99999999", desc = "Go to top" },
  { on = ["<End>"], run = "arrow 99999999", desc = "Go to bottom" },

  # Selection
  { on = ["<Space>"], run = ["select --state=none", "arrow 1"], desc = "Toggle select" },
  { on = ["<C-a>"], run = "select_all --state=true", desc = "Select all" },

  # Operations
  { on = ["<Enter>"], run = "open", desc = "Open" },
  { on = ["<C-c>"], run = "yank", desc = "Copy" },
  { on = ["<C-x>"], run = "yank --cut", desc = "Cut" },
  { on = ["<C-v>"], run = "paste", desc = "Paste" },
  { on = ["<Delete>"], run = "remove", desc = "Trash" },
  { on = ["<S-Delete>"], run = "remove --permanently", desc = "Delete" },
  { on = ["<C-n>"], run = "create", desc = "New file/dir" },
  { on = ["<F2>"], run = "rename --cursor=before_ext", desc = "Rename" },

  # Find
  { on = ["<C-f>"], run = "find --smart", desc = "Find" },
  { on = ["<F3>"], run = "find_arrow", desc = "Next match" },
  { on = ["<S-F3>"], run = "find_arrow --previous", desc = "Prev match" },

  # Goto
  { on = ["<A-h>"], run = "cd ~", desc = "Go home" },
  { on = ["<A-d>"], run = "cd ~/Downloads", desc = "Go downloads" },

  # Toggle
  { on = ["<C-h>"], run = "hidden toggle", desc = "Toggle hidden" },
]
KEYMAP_EMACS_EOF
    fi

    # Generate theme file based on selected theme
    generate_yazi_theme > ~/.config/yazi/theme.toml

    print_success "Yazi configured ($NAV_STYLE navigation)"
}

# ============================================================================
# GIT CONFIGURATION
# ============================================================================

setup_git() {
    print_header "Configuring Git"

    # Backup existing gitconfig
    [[ -n "${BACKUP_SESSION_DIR:-}" ]] && backup_file "$HOME/.gitconfig"

    load_theme_colors
    local dark_mode="true"
    [[ "$T_IS_LIGHT" == "true" ]] && dark_mode="false"

    cat > ~/.gitconfig << GIT_EOF
[core]
    pager = delta

[interactive]
    diffFilter = delta --color-only

[delta]
    navigate = true
    dark = $dark_mode
    side-by-side = true
    line-numbers = true
    syntax-theme = $T_DELTA_THEME
    file-style = bold yellow ul
    file-decoration-style = none
    hunk-header-style = file line-number syntax
    hunk-header-decoration-style = blue box

[merge]
    conflictstyle = diff3

[diff]
    colorMoved = default

[alias]
    st = status -sb
    co = checkout
    br = branch
    ci = commit
    lg = log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit
    last = log -1 HEAD --stat
    unstage = reset HEAD --
GIT_EOF

    print_warning "Remember to set your git user.name and user.email!"
    print_success "Git configured ($THEME theme)"
}

# ============================================================================
# BAT CONFIGURATION
# ============================================================================

setup_bat() {
    print_header "Configuring Bat"

    # Backup existing bat config
    [[ -n "${BACKUP_SESSION_DIR:-}" ]] && backup_file "$HOME/.config/bat/config"

    mkdir -p ~/.config/bat
    generate_bat_config > ~/.config/bat/config

    print_success "Bat configured ($THEME theme)"
}

# ============================================================================
# UTILITY SCRIPTS
# ============================================================================

setup_utilities() {
    print_header "Setting Up Utility Scripts"

    # Backup existing utility scripts
    [[ -n "${BACKUP_SESSION_DIR:-}" ]] && {
        backup_file "$HOME/.local/bin/hk"
        backup_file "$HOME/.local/bin/caff"
        backup_file "$HOME/.local/bin/sshh"
        backup_file "$HOME/.local/bin/dotfiles"
        backup_file "$HOME/.sshh"
    }

    mkdir -p ~/.local/bin

    # Hotkey reference (navigation-style dependent)
    if [[ "$NAV_STYLE" == "vim" ]]; then
        cat > ~/.local/bin/hk << 'HK_VIM_EOF'
#!/usr/bin/env bash
cat << 'EOF'
╔══════════════════════════════════════════════════════════════════════════════╗
║                         HOTKEY REFERENCE (vim style)                         ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ TMUX (prefix = Ctrl-a)                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│ Ctrl-a |         Split vertical          Alt-h/j/k/l    Navigate panes     │
│ Ctrl-a -         Split horizontal        Alt-1/2/3/4/5  Switch window      │
│ Ctrl-a c         New window              Ctrl-a d       Detach             │
│ Ctrl-a h/j/k/l   Navigate panes          Ctrl-a r       Reload config      │
│ Ctrl-a H/J/K/L   Resize panes            Ctrl-a [       Copy mode (vim)    │
│ Ctrl-a n/p       Next/prev window        v/y            Select/yank (copy) │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ZSH (vim mode)                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ Esc              Enter normal mode       Ctrl-p/n       History up/down    │
│ Ctrl-e           Edit command in nvim    Ctrl-w         Delete word back   │
│ Ctrl-r           Search history          Ctrl-f         Accept suggestion  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ YAZI (file manager, launch with: y)                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ h/j/k/l          Navigate                .              Toggle hidden      │
│ J/K              Move 5 lines            /              Search             │
│ gg/G             Top/bottom              f              Filter             │
│ Space            Toggle select           v              Visual mode        │
│ Enter/o          Open                    a              Create file/dir    │
│ y                Yank (copy)             r              Rename             │
│ x                Cut                     d              Trash              │
│ p                Paste                   D              Delete permanent   │
│ q                Quit (cd to dir)        Q              Quit (stay)        │
│ gh               Go home                 gc             Go ~/.config       │
│ gd               Go ~/Downloads                                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ EZA (ls replacement)                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ ls               List with icons         la             List all + git     │
│ ll               Long format + git       lt             Tree view          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ZOXIDE (smart cd)                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ cd <query>       Jump to frecent dir     cd -           Previous dir       │
│ zi               Interactive selection                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ FZF (fuzzy finder)                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Ctrl-r           Fuzzy search history    Ctrl-t         Fuzzy find file    │
│ Alt-c            Fuzzy cd into dir       **<Tab>        Path completion    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ GHOSTTY                                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Super-c/v        Copy/Paste (macOS-style) Super-1/2/3... Switch to tab N   │
│ Super-{/}        Prev/next tab           Ctrl-Shift-n   New window         │
│ Ctrl-Shift-,     Reload config           Ctrl-Shift-c/v Alternate copy/paste│
│ Cmd-c/v          Copy/Paste (macOS)      Cmd-1/2/3...   Switch tab (macOS) │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ NVIM (basics)                                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ i                Insert mode             Esc            Normal mode        │
│ :w               Save                    :q             Quit               │
│ :wq              Save and quit           :q!            Quit no save       │
│ h/j/k/l          Navigate                dd             Delete line        │
│ yy               Yank line               p              Paste              │
│ u                Undo                    Ctrl-r         Redo               │
│ /                Search                  n/N            Next/prev match    │
│ Space            Leader key (menu)       :Tutor         Built-in tutorial  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ CAFF (caffeine - prevent sleep)                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ caff             Toggle on/off           caff status    Check state        │
│ caff on          Keep awake              caff off       Allow sleep        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SSHH (quick SSH connect)                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ sshh             Show menu & select      sshh 1/2/3     Connect directly   │
│ sshh list        List all hosts          sshh edit      Edit ~/.sshh       │
│ sshh add "Name" "user@host" [port]       Add new host                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ DOTFILES (theme & user management)                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ dotfiles status              Show current settings (user, theme, nav, kbd)  │
│ dotfiles theme <name>        Switch theme (e.g., dracula, nord, gruvbox)    │
│ dotfiles nav emacs|vim       Set navigation style                           │
│ dotfiles keyboard macos|linux  Set keyboard style for Ghostty/DE shortcuts  │
│ dotfiles list-themes         Show all 13 available themes                   │
│ dotfiles --<User>            Quick switch user (e.g., dotfiles --Pratik)    │
│ dotfiles user <name>         Switch to user profile                         │
│ dotfiles user add <name>     Create new user (interactive or with flags)    │
│ dotfiles users               List all user profiles                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ macOS APPS (Rectangle, Raycast, AltTab)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Ctrl-Opt-←/→     Half left/right         Ctrl-Opt-↑     Maximize           │
│ Ctrl-Opt-Enter   Full screen             Ctrl-Opt-C     Center window      │
│ Ctrl-Opt-U/I/J/K Corners                 Cmd-Space      Raycast launcher   │
│ Opt-Tab          AltTab switcher         Opt-`          Same app windows   │
└─────────────────────────────────────────────────────────────────────────────┘
EOF
HK_VIM_EOF
    else
        cat > ~/.local/bin/hk << 'HK_EMACS_EOF'
#!/usr/bin/env bash
cat << 'EOF'
╔══════════════════════════════════════════════════════════════════════════════╗
║                      HOTKEY REFERENCE (emacs/Mac style)                      ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ TMUX (prefix = Ctrl-a)                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│ Ctrl-a |         Split vertical          Alt-Arrow      Navigate panes     │
│ Ctrl-a -         Split horizontal        Alt-1/2/3/4/5  Switch window      │
│ Ctrl-a c         New window              Ctrl-a d       Detach             │
│ Ctrl-a Arrow     Navigate panes          Ctrl-a r       Reload config      │
│ Ctrl-a S-Arrow   Resize panes            Ctrl-a [       Copy mode          │
│ Ctrl-a n/p       Next/prev window                                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ZSH (emacs/Mac-style)                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ Ctrl-a/e         Start/end of line       Ctrl-p/n       History up/down    │
│ Ctrl-x Ctrl-e    Edit command in nvim    Ctrl-w         Delete word back   │
│ Ctrl-r           Search history          Ctrl-f         Accept suggestion  │
│ Alt-b/f          Word back/forward       Ctrl-k         Kill to end        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ YAZI (file manager, launch with: y)                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ Arrow keys       Navigate                Ctrl-h         Toggle hidden      │
│ Shift-Up/Down    Move 5 lines            Ctrl-f         Search             │
│ Home/End         Top/bottom              PageUp/Down    Half page          │
│ Space            Toggle select           Ctrl-a         Select all         │
│ Enter            Open                    Ctrl-n         New file/dir       │
│ Ctrl-c           Copy                    F2             Rename             │
│ Ctrl-x           Cut                     Delete         Trash              │
│ Ctrl-v           Paste                   Shift-Delete   Delete permanent   │
│ q                Quit (cd to dir)        Q              Quit (stay)        │
│ Alt-h            Go home                 Alt-d          Go ~/Downloads     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ EZA (ls replacement)                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ ls               List with icons         la             List all + git     │
│ ll               Long format + git       lt             Tree view          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ZOXIDE (smart cd)                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ cd <query>       Jump to frecent dir     cd -           Previous dir       │
│ zi               Interactive selection                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ FZF (fuzzy finder)                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Ctrl-r           Fuzzy search history    Ctrl-t         Fuzzy find file    │
│ Alt-c            Fuzzy cd into dir       **<Tab>        Path completion    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ GHOSTTY                                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Super-c/v        Copy/Paste (macOS-style) Super-1/2/3... Switch to tab N   │
│ Super-{/}        Prev/next tab           Ctrl-Shift-n   New window         │
│ Ctrl-Shift-,     Reload config           Ctrl-Shift-c/v Alternate copy/paste│
│ Cmd-c/v          Copy/Paste (macOS)      Cmd-1/2/3...   Switch tab (macOS) │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ NVIM (basics)                                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ i                Insert mode             Esc            Normal mode        │
│ :w               Save                    :q             Quit               │
│ :wq              Save and quit           :q!            Quit no save       │
│ Arrow keys       Navigate                dd             Delete line        │
│ yy               Yank line               p              Paste              │
│ u                Undo                    Ctrl-r         Redo               │
│ /                Search                  n/N            Next/prev match    │
│ Space            Leader key (menu)       :Tutor         Built-in tutorial  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ CAFF (caffeine - prevent sleep)                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ caff             Toggle on/off           caff status    Check state        │
│ caff on          Keep awake              caff off       Allow sleep        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SSHH (quick SSH connect)                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ sshh             Show menu & select      sshh 1/2/3     Connect directly   │
│ sshh list        List all hosts          sshh edit      Edit ~/.sshh       │
│ sshh add "Name" "user@host" [port]       Add new host                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ DOTFILES (theme & user management)                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ dotfiles status              Show current settings (user, theme, nav, kbd)  │
│ dotfiles theme <name>        Switch theme (e.g., dracula, nord, gruvbox)    │
│ dotfiles nav emacs|vim       Set navigation style                           │
│ dotfiles keyboard macos|linux  Set keyboard style for Ghostty/DE shortcuts  │
│ dotfiles list-themes         Show all 13 available themes                   │
│ dotfiles --<User>            Quick switch user (e.g., dotfiles --Pratik)    │
│ dotfiles user <name>         Switch to user profile                         │
│ dotfiles user add <name>     Create new user (interactive or with flags)    │
│ dotfiles users               List all user profiles                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ macOS APPS (Rectangle, Raycast, AltTab)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Ctrl-Opt-←/→     Half left/right         Ctrl-Opt-↑     Maximize           │
│ Ctrl-Opt-Enter   Full screen             Ctrl-Opt-C     Center window      │
│ Ctrl-Opt-U/I/J/K Corners                 Cmd-Space      Raycast launcher   │
│ Opt-Tab          AltTab switcher         Opt-`          Same app windows   │
└─────────────────────────────────────────────────────────────────────────────┘
EOF
HK_EMACS_EOF
    fi
    chmod +x ~/.local/bin/hk

    # Caffeine script
    cat > ~/.local/bin/caff << 'CAFF_EOF'
#!/usr/bin/env bash

PIDFILE="/tmp/caffeine-$USER.pid"

status() {
    if [[ -f "$PIDFILE" ]] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
        echo "☕ Caffeine: ON (PID $(cat "$PIDFILE"))"
        return 0
    else
        echo "😴 Caffeine: OFF"
        rm -f "$PIDFILE" 2>/dev/null
        return 1
    fi
}

start() {
    if status > /dev/null 2>&1; then
        echo "☕ Caffeine is already running"
        return 0
    fi

    if [[ "$OSTYPE" == "darwin"* ]]; then
        caffeinate -di &
    else
        systemd-inhibit --what=idle:sleep:handle-lid-switch \
            --who="caffeine" \
            --why="User requested stay awake" \
            --mode=block \
            sleep infinity &
    fi

    echo $! > "$PIDFILE"
    echo "☕ Caffeine: ON - system will stay awake"
}

stop() {
    if [[ -f "$PIDFILE" ]]; then
        pid=$(cat "$PIDFILE")
        if kill "$pid" 2>/dev/null; then
            rm -f "$PIDFILE"
            echo "😴 Caffeine: OFF - sleep enabled"
            return 0
        fi
    fi
    echo "😴 Caffeine is not running"
    rm -f "$PIDFILE" 2>/dev/null
}

toggle() {
    if status > /dev/null 2>&1; then
        stop
    else
        start
    fi
}

case "${1:-toggle}" in
    on|start) start ;;
    off|stop) stop ;;
    status) status ;;
    toggle|"") toggle ;;
    *)
        echo "Usage: caff [on|off|status|toggle]"
        exit 1
        ;;
esac
CAFF_EOF
    chmod +x ~/.local/bin/caff

    # SSH Quick Connect
    cat > ~/.local/bin/sshh << 'SSHH_EOF'
#!/usr/bin/env bash
#
# sshh - Quick SSH connection manager
# Reads hosts from ~/.sshh and provides a simple menu
#

CONFIG_FILE="$HOME/.sshh"

CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
PURPLE='\033[0;35m'
RED='\033[0;31m'
DIM='\033[2m'
NC='\033[0m'

if [[ ! -f "$CONFIG_FILE" ]]; then
    echo -e "${RED}✗${NC} Config file not found: ${CYAN}$CONFIG_FILE${NC}"
    echo ""
    echo "Create it with format: name | user@host | port (port optional)"
    echo -e "Example: ${CYAN}Work Server${NC} | ${GREEN}admin@192.168.1.100${NC}"
    exit 1
fi

declare -a NAMES CONNECTIONS PORTS

while IFS= read -r line || [[ -n "$line" ]]; do
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
    IFS='|' read -ra PARTS <<< "$line"
    name=$(echo "${PARTS[0]}" | xargs)
    conn=$(echo "${PARTS[1]}" | xargs)
    port=$(echo "${PARTS[2]:-22}" | xargs)
    if [[ -n "$name" && -n "$conn" ]]; then
        NAMES+=("$name")
        CONNECTIONS+=("$conn")
        PORTS+=("$port")
    fi
done < "$CONFIG_FILE"

if [[ ${#NAMES[@]} -eq 0 ]]; then
    echo -e "${RED}✗${NC} No hosts found in ${CYAN}$CONFIG_FILE${NC}"
    exit 1
fi

show_menu() {
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${PURPLE}  SSH Quick Connect${NC}"
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    for i in "${!NAMES[@]}"; do
        num=$((i + 1))
        port_display=""
        [[ "${PORTS[$i]}" != "22" ]] && port_display="${DIM}:${PORTS[$i]}${NC}"
        printf "  ${YELLOW}%d${NC}  ${CYAN}%-20s${NC} ${GREEN}%s${NC}%s\n" \
            "$num" "${NAMES[$i]}" "${CONNECTIONS[$i]}" "$port_display"
    done
    echo ""
    echo -e "  ${DIM}q  Quit${NC}"
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

if [[ -n "$1" ]]; then
    if [[ "$1" =~ ^[0-9]+$ ]]; then
        idx=$(($1 - 1))
        if [[ $idx -ge 0 && $idx -lt ${#NAMES[@]} ]]; then
            echo -e "${GREEN}▶${NC} Connecting to ${CYAN}${NAMES[$idx]}${NC}..."
            [[ "${PORTS[$idx]}" != "22" ]] && exec ssh -p "${PORTS[$idx]}" "${CONNECTIONS[$idx]}"
            exec ssh "${CONNECTIONS[$idx]}"
        fi
        echo -e "${RED}✗${NC} Invalid selection: $1" && exit 1
    elif [[ "$1" == "list" || "$1" == "-l" ]]; then
        show_menu && exit 0
    elif [[ "$1" == "edit" || "$1" == "-e" ]]; then
        ${EDITOR:-nvim} "$CONFIG_FILE" && exit 0
    elif [[ "$1" == "add" ]]; then
        shift
        if [[ $# -ge 2 ]]; then
            echo "$1 | $2 | ${3:-22}" >> "$CONFIG_FILE"
            echo -e "${GREEN}✓${NC} Added: ${CYAN}$1${NC} → ${GREEN}$2${NC}"
            exit 0
        fi
        echo "Usage: sshh add \"Name\" \"user@host\" [port]" && exit 1
    elif [[ "$1" == "help" || "$1" == "-h" ]]; then
        echo "Usage: sshh [command|number]"
        echo "  (none)    Show menu"
        echo "  <num>     Connect to host #"
        echo "  list      Show hosts"
        echo "  edit      Edit config"
        echo "  add       Add host"
        exit 0
    fi
    echo -e "${RED}✗${NC} Unknown: $1" && exit 1
fi

show_menu
echo -ne "Select [1-${#NAMES[@]}]: "
read -r choice
[[ "$choice" == "q" || "$choice" == "Q" ]] && exit 0
if [[ "$choice" =~ ^[0-9]+$ ]]; then
    idx=$((choice - 1))
    if [[ $idx -ge 0 && $idx -lt ${#NAMES[@]} ]]; then
        echo -e "\n${GREEN}▶${NC} Connecting to ${CYAN}${NAMES[$idx]}${NC}...\n"
        [[ "${PORTS[$idx]}" != "22" ]] && exec ssh -p "${PORTS[$idx]}" "${CONNECTIONS[$idx]}"
        exec ssh "${CONNECTIONS[$idx]}"
    fi
fi
echo -e "${RED}✗${NC} Invalid selection" && exit 1
SSHH_EOF
    chmod +x ~/.local/bin/sshh

    # Create template .sshh config if it doesn't exist
    if [[ ! -f ~/.sshh ]]; then
        cat > ~/.sshh << 'SSHH_CONFIG_EOF'
# SSH Quick Connect Configuration
# Format: Name | user@host | port (port is optional, defaults to 22)
#
# Examples:
# Work Server | admin@192.168.1.100
# Home NAS | user@nas.local | 2222
# Raspberry Pi | pi@raspberrypi.local

SSHH_CONFIG_EOF
        print_success "Created ~/.sshh template"
    fi

    # Create dotfiles management CLI
    cat > ~/.local/bin/dotfiles << 'DOTFILES_CLI_EOF'
#!/usr/bin/env bash
#
# dotfiles - Terminal environment management CLI
# Switch themes and navigation styles dynamically
#

VERSION="1.1.0"
DOTFILES_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/dotfiles"
DOTFILES_USERS_DIR="$DOTFILES_CONFIG_DIR/users"
SUPPORTED_THEMES="catppuccin-mocha catppuccin-latte catppuccin-frappe catppuccin-macchiato dracula gruvbox-dark gruvbox-light nord tokyo-night solarized-dark solarized-light monokai rose-pine"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Safe setting parser - extracts only known variables (no arbitrary code execution)
safe_read_setting() {
    local file="$1" key="$2" default="${3:-}"
    if [[ -f "$file" ]]; then
        local value
        value=$(grep -E "^${key}=" "$file" 2>/dev/null | head -1 | cut -d'=' -f2- | sed 's/^["'"'"']//;s/["'"'"']$//')
        echo "${value:-$default}"
    else
        echo "$default"
    fi
}

# Load current settings
load_settings() {
    local settings_file="$DOTFILES_CONFIG_DIR/settings"
    THEME=$(safe_read_setting "$settings_file" "THEME" "catppuccin-mocha")
    NAV_STYLE=$(safe_read_setting "$settings_file" "NAV_STYLE" "emacs")
    KEYBOARD_STYLE=$(safe_read_setting "$settings_file" "KEYBOARD_STYLE" "linux")
    KEYBOARD_ENABLED=$(safe_read_setting "$settings_file" "KEYBOARD_ENABLED" "no")
    ACTIVE_USER=$(safe_read_setting "$settings_file" "ACTIVE_USER" "")
}

# Save settings
save_settings() {
    mkdir -p "$DOTFILES_CONFIG_DIR"
    chmod 700 "$DOTFILES_CONFIG_DIR"
    cat > "$DOTFILES_CONFIG_DIR/settings" << EOF
THEME="$THEME"
NAV_STYLE="$NAV_STYLE"
KEYBOARD_STYLE="${KEYBOARD_STYLE:-linux}"
KEYBOARD_ENABLED="${KEYBOARD_ENABLED:-no}"
ACTIVE_USER="$ACTIVE_USER"
EOF
    chmod 600 "$DOTFILES_CONFIG_DIR/settings"
}

# Theme color loader (same as in dotfiles-setup)
load_theme_colors() {
    local theme="${1:-$THEME}"
    case "$theme" in
        catppuccin-mocha)
            T_BG="#1e1e2e"; T_FG="#cdd6f4"; T_CURSOR="#f5e0dc"; T_CURSOR_TEXT="#1e1e2e"
            T_SEL_BG="#585b70"; T_SEL_FG="#cdd6f4"
            T_BLACK="#45475a"; T_BRIGHT_BLACK="#585b70"; T_RED="#f38ba8"; T_BRIGHT_RED="#f38ba8"
            T_GREEN="#a6e3a1"; T_BRIGHT_GREEN="#a6e3a1"; T_YELLOW="#f9e2af"; T_BRIGHT_YELLOW="#f9e2af"
            T_BLUE="#89b4fa"; T_BRIGHT_BLUE="#89b4fa"; T_MAGENTA="#f5c2e7"; T_BRIGHT_MAGENTA="#f5c2e7"
            T_CYAN="#94e2d5"; T_BRIGHT_CYAN="#94e2d5"; T_WHITE="#bac2de"; T_BRIGHT_WHITE="#a6adc8"
            T_ACCENT="#89b4fa"; T_ACCENT2="#a6e3a1"; T_ACCENT3="#f38ba8"
            T_SURFACE="#313244"; T_OVERLAY="#45475a"; T_MUTED="#6c7086"
            T_BAT_THEME="Catppuccin Mocha"; T_DELTA_THEME="Catppuccin Mocha"; T_IS_LIGHT=false ;;
        catppuccin-latte)
            T_BG="#eff1f5"; T_FG="#4c4f69"; T_CURSOR="#dc8a78"; T_CURSOR_TEXT="#eff1f5"
            T_SEL_BG="#acb0be"; T_SEL_FG="#4c4f69"
            T_BLACK="#5c5f77"; T_BRIGHT_BLACK="#6c6f85"; T_RED="#d20f39"; T_BRIGHT_RED="#d20f39"
            T_GREEN="#40a02b"; T_BRIGHT_GREEN="#40a02b"; T_YELLOW="#df8e1d"; T_BRIGHT_YELLOW="#df8e1d"
            T_BLUE="#1e66f5"; T_BRIGHT_BLUE="#1e66f5"; T_MAGENTA="#ea76cb"; T_BRIGHT_MAGENTA="#ea76cb"
            T_CYAN="#179299"; T_BRIGHT_CYAN="#179299"; T_WHITE="#acb0be"; T_BRIGHT_WHITE="#bcc0cc"
            T_ACCENT="#1e66f5"; T_ACCENT2="#40a02b"; T_ACCENT3="#d20f39"
            T_SURFACE="#ccd0da"; T_OVERLAY="#bcc0cc"; T_MUTED="#8c8fa1"
            T_BAT_THEME="Catppuccin Latte"; T_DELTA_THEME="Catppuccin Latte"; T_IS_LIGHT=true ;;
        dracula)
            T_BG="#282a36"; T_FG="#f8f8f2"; T_CURSOR="#f8f8f2"; T_CURSOR_TEXT="#282a36"
            T_SEL_BG="#44475a"; T_SEL_FG="#f8f8f2"
            T_BLACK="#21222c"; T_BRIGHT_BLACK="#6272a4"; T_RED="#ff5555"; T_BRIGHT_RED="#ff6e6e"
            T_GREEN="#50fa7b"; T_BRIGHT_GREEN="#69ff94"; T_YELLOW="#f1fa8c"; T_BRIGHT_YELLOW="#ffffa5"
            T_BLUE="#bd93f9"; T_BRIGHT_BLUE="#d6acff"; T_MAGENTA="#ff79c6"; T_BRIGHT_MAGENTA="#ff92df"
            T_CYAN="#8be9fd"; T_BRIGHT_CYAN="#a4ffff"; T_WHITE="#f8f8f2"; T_BRIGHT_WHITE="#ffffff"
            T_ACCENT="#bd93f9"; T_ACCENT2="#50fa7b"; T_ACCENT3="#ff79c6"
            T_SURFACE="#44475a"; T_OVERLAY="#6272a4"; T_MUTED="#6272a4"
            T_BAT_THEME="Dracula"; T_DELTA_THEME="Dracula"; T_IS_LIGHT=false ;;
        gruvbox-dark)
            T_BG="#282828"; T_FG="#ebdbb2"; T_CURSOR="#ebdbb2"; T_CURSOR_TEXT="#282828"
            T_SEL_BG="#504945"; T_SEL_FG="#ebdbb2"
            T_BLACK="#282828"; T_BRIGHT_BLACK="#928374"; T_RED="#cc241d"; T_BRIGHT_RED="#fb4934"
            T_GREEN="#98971a"; T_BRIGHT_GREEN="#b8bb26"; T_YELLOW="#d79921"; T_BRIGHT_YELLOW="#fabd2f"
            T_BLUE="#458588"; T_BRIGHT_BLUE="#83a598"; T_MAGENTA="#b16286"; T_BRIGHT_MAGENTA="#d3869b"
            T_CYAN="#689d6a"; T_BRIGHT_CYAN="#8ec07c"; T_WHITE="#a89984"; T_BRIGHT_WHITE="#ebdbb2"
            T_ACCENT="#83a598"; T_ACCENT2="#b8bb26"; T_ACCENT3="#fb4934"
            T_SURFACE="#3c3836"; T_OVERLAY="#504945"; T_MUTED="#928374"
            T_BAT_THEME="gruvbox-dark"; T_DELTA_THEME="gruvbox-dark"; T_IS_LIGHT=false ;;
        gruvbox-light)
            T_BG="#fbf1c7"; T_FG="#3c3836"; T_CURSOR="#3c3836"; T_CURSOR_TEXT="#fbf1c7"
            T_SEL_BG="#d5c4a1"; T_SEL_FG="#3c3836"
            T_BLACK="#fbf1c7"; T_BRIGHT_BLACK="#928374"; T_RED="#cc241d"; T_BRIGHT_RED="#9d0006"
            T_GREEN="#98971a"; T_BRIGHT_GREEN="#79740e"; T_YELLOW="#d79921"; T_BRIGHT_YELLOW="#b57614"
            T_BLUE="#458588"; T_BRIGHT_BLUE="#076678"; T_MAGENTA="#b16286"; T_BRIGHT_MAGENTA="#8f3f71"
            T_CYAN="#689d6a"; T_BRIGHT_CYAN="#427b58"; T_WHITE="#7c6f64"; T_BRIGHT_WHITE="#3c3836"
            T_ACCENT="#076678"; T_ACCENT2="#79740e"; T_ACCENT3="#9d0006"
            T_SURFACE="#ebdbb2"; T_OVERLAY="#d5c4a1"; T_MUTED="#928374"
            T_BAT_THEME="gruvbox-light"; T_DELTA_THEME="gruvbox-light"; T_IS_LIGHT=true ;;
        nord)
            T_BG="#2e3440"; T_FG="#d8dee9"; T_CURSOR="#d8dee9"; T_CURSOR_TEXT="#2e3440"
            T_SEL_BG="#434c5e"; T_SEL_FG="#d8dee9"
            T_BLACK="#3b4252"; T_BRIGHT_BLACK="#4c566a"; T_RED="#bf616a"; T_BRIGHT_RED="#bf616a"
            T_GREEN="#a3be8c"; T_BRIGHT_GREEN="#a3be8c"; T_YELLOW="#ebcb8b"; T_BRIGHT_YELLOW="#ebcb8b"
            T_BLUE="#81a1c1"; T_BRIGHT_BLUE="#81a1c1"; T_MAGENTA="#b48ead"; T_BRIGHT_MAGENTA="#b48ead"
            T_CYAN="#88c0d0"; T_BRIGHT_CYAN="#8fbcbb"; T_WHITE="#e5e9f0"; T_BRIGHT_WHITE="#eceff4"
            T_ACCENT="#88c0d0"; T_ACCENT2="#a3be8c"; T_ACCENT3="#bf616a"
            T_SURFACE="#3b4252"; T_OVERLAY="#434c5e"; T_MUTED="#4c566a"
            T_BAT_THEME="Nord"; T_DELTA_THEME="Nord"; T_IS_LIGHT=false ;;
        tokyo-night)
            T_BG="#1a1b26"; T_FG="#a9b1d6"; T_CURSOR="#c0caf5"; T_CURSOR_TEXT="#1a1b26"
            T_SEL_BG="#33467c"; T_SEL_FG="#c0caf5"
            T_BLACK="#15161e"; T_BRIGHT_BLACK="#414868"; T_RED="#f7768e"; T_BRIGHT_RED="#f7768e"
            T_GREEN="#9ece6a"; T_BRIGHT_GREEN="#9ece6a"; T_YELLOW="#e0af68"; T_BRIGHT_YELLOW="#e0af68"
            T_BLUE="#7aa2f7"; T_BRIGHT_BLUE="#7aa2f7"; T_MAGENTA="#bb9af7"; T_BRIGHT_MAGENTA="#bb9af7"
            T_CYAN="#7dcfff"; T_BRIGHT_CYAN="#7dcfff"; T_WHITE="#a9b1d6"; T_BRIGHT_WHITE="#c0caf5"
            T_ACCENT="#7aa2f7"; T_ACCENT2="#9ece6a"; T_ACCENT3="#f7768e"
            T_SURFACE="#24283b"; T_OVERLAY="#414868"; T_MUTED="#565f89"
            T_BAT_THEME="TwoDark"; T_DELTA_THEME="TwoDark"; T_IS_LIGHT=false ;;
        solarized-dark)
            T_BG="#002b36"; T_FG="#839496"; T_CURSOR="#839496"; T_CURSOR_TEXT="#002b36"
            T_SEL_BG="#073642"; T_SEL_FG="#93a1a1"
            T_BLACK="#073642"; T_BRIGHT_BLACK="#586e75"; T_RED="#dc322f"; T_BRIGHT_RED="#cb4b16"
            T_GREEN="#859900"; T_BRIGHT_GREEN="#586e75"; T_YELLOW="#b58900"; T_BRIGHT_YELLOW="#657b83"
            T_BLUE="#268bd2"; T_BRIGHT_BLUE="#839496"; T_MAGENTA="#d33682"; T_BRIGHT_MAGENTA="#6c71c4"
            T_CYAN="#2aa198"; T_BRIGHT_CYAN="#93a1a1"; T_WHITE="#eee8d5"; T_BRIGHT_WHITE="#fdf6e3"
            T_ACCENT="#268bd2"; T_ACCENT2="#859900"; T_ACCENT3="#dc322f"
            T_SURFACE="#073642"; T_OVERLAY="#586e75"; T_MUTED="#657b83"
            T_BAT_THEME="Solarized (dark)"; T_DELTA_THEME="Solarized (dark)"; T_IS_LIGHT=false ;;
        solarized-light)
            T_BG="#fdf6e3"; T_FG="#657b83"; T_CURSOR="#657b83"; T_CURSOR_TEXT="#fdf6e3"
            T_SEL_BG="#eee8d5"; T_SEL_FG="#586e75"
            T_BLACK="#073642"; T_BRIGHT_BLACK="#002b36"; T_RED="#dc322f"; T_BRIGHT_RED="#cb4b16"
            T_GREEN="#859900"; T_BRIGHT_GREEN="#586e75"; T_YELLOW="#b58900"; T_BRIGHT_YELLOW="#657b83"
            T_BLUE="#268bd2"; T_BRIGHT_BLUE="#839496"; T_MAGENTA="#d33682"; T_BRIGHT_MAGENTA="#6c71c4"
            T_CYAN="#2aa198"; T_BRIGHT_CYAN="#93a1a1"; T_WHITE="#eee8d5"; T_BRIGHT_WHITE="#fdf6e3"
            T_ACCENT="#268bd2"; T_ACCENT2="#859900"; T_ACCENT3="#dc322f"
            T_SURFACE="#eee8d5"; T_OVERLAY="#93a1a1"; T_MUTED="#839496"
            T_BAT_THEME="Solarized (light)"; T_DELTA_THEME="Solarized (light)"; T_IS_LIGHT=true ;;
        monokai)
            T_BG="#272822"; T_FG="#f8f8f2"; T_CURSOR="#f8f8f2"; T_CURSOR_TEXT="#272822"
            T_SEL_BG="#49483e"; T_SEL_FG="#f8f8f2"
            T_BLACK="#272822"; T_BRIGHT_BLACK="#75715e"; T_RED="#f92672"; T_BRIGHT_RED="#f92672"
            T_GREEN="#a6e22e"; T_BRIGHT_GREEN="#a6e22e"; T_YELLOW="#f4bf75"; T_BRIGHT_YELLOW="#f4bf75"
            T_BLUE="#66d9ef"; T_BRIGHT_BLUE="#66d9ef"; T_MAGENTA="#ae81ff"; T_BRIGHT_MAGENTA="#ae81ff"
            T_CYAN="#a1efe4"; T_BRIGHT_CYAN="#a1efe4"; T_WHITE="#f8f8f2"; T_BRIGHT_WHITE="#f9f8f5"
            T_ACCENT="#66d9ef"; T_ACCENT2="#a6e22e"; T_ACCENT3="#f92672"
            T_SURFACE="#3e3d32"; T_OVERLAY="#49483e"; T_MUTED="#75715e"
            T_BAT_THEME="Monokai Extended"; T_DELTA_THEME="Monokai Extended"; T_IS_LIGHT=false ;;
        rose-pine)
            T_BG="#191724"; T_FG="#e0def4"; T_CURSOR="#524f67"; T_CURSOR_TEXT="#e0def4"
            T_SEL_BG="#403d52"; T_SEL_FG="#e0def4"
            T_BLACK="#26233a"; T_BRIGHT_BLACK="#6e6a86"; T_RED="#eb6f92"; T_BRIGHT_RED="#eb6f92"
            T_GREEN="#9ccfd8"; T_BRIGHT_GREEN="#9ccfd8"; T_YELLOW="#f6c177"; T_BRIGHT_YELLOW="#f6c177"
            T_BLUE="#31748f"; T_BRIGHT_BLUE="#31748f"; T_MAGENTA="#c4a7e7"; T_BRIGHT_MAGENTA="#c4a7e7"
            T_CYAN="#ebbcba"; T_BRIGHT_CYAN="#ebbcba"; T_WHITE="#e0def4"; T_BRIGHT_WHITE="#e0def4"
            T_ACCENT="#c4a7e7"; T_ACCENT2="#9ccfd8"; T_ACCENT3="#eb6f92"
            T_SURFACE="#1f1d2e"; T_OVERLAY="#26233a"; T_MUTED="#6e6a86"
            T_BAT_THEME="base16"; T_DELTA_THEME="base16"; T_IS_LIGHT=false ;;
        *) # Default catppuccin variants
            load_theme_colors "catppuccin-mocha" ;;
    esac
}

# ============================================================================
# USER MANAGEMENT FUNCTIONS
# ============================================================================

# Validate username (alphanumeric, underscores, hyphens, 1-32 chars)
validate_username() {
    local username="$1"
    if [[ ! "$username" =~ ^[a-zA-Z][a-zA-Z0-9_-]{0,31}$ ]]; then
        echo -e "${RED}Error: Invalid username '${username}'${NC}"
        echo "Username must start with a letter and contain only letters, numbers, underscores, or hyphens (max 32 chars)."
        return 1
    fi
    return 0
}

# Check if user profile exists
user_exists() {
    local username="$1"
    [[ -f "$DOTFILES_USERS_DIR/${username}.settings" ]]
}

# Load user profile
load_user_profile() {
    local username="$1"
    local profile="$DOTFILES_USERS_DIR/${username}.settings"
    if [[ -f "$profile" ]]; then
        # Safe loading - only read known variables
        THEME=$(safe_read_setting "$profile" "THEME" "catppuccin-mocha")
        NAV_STYLE=$(safe_read_setting "$profile" "NAV_STYLE" "emacs")
        KEYBOARD_STYLE=$(safe_read_setting "$profile" "KEYBOARD_STYLE" "macos")
        KEYBOARD_ENABLED=$(safe_read_setting "$profile" "KEYBOARD_ENABLED" "no")
        return 0
    fi
    return 1
}

# Save user profile
save_user_profile() {
    local username="$1"
    mkdir -p "$DOTFILES_USERS_DIR"
    chmod 700 "$DOTFILES_USERS_DIR"
    cat > "$DOTFILES_USERS_DIR/${username}.settings" << EOF
# User: $username
THEME="$THEME"
NAV_STYLE="$NAV_STYLE"
KEYBOARD_STYLE="${KEYBOARD_STYLE:-macos}"
KEYBOARD_ENABLED="${KEYBOARD_ENABLED:-no}"
EOF
    chmod 600 "$DOTFILES_USERS_DIR/${username}.settings"
}

# List all user profiles
list_users() {
    load_settings
    echo -e "${BLUE}User Profiles:${NC}"

    if [[ ! -d "$DOTFILES_USERS_DIR" ]] || [[ -z "$(ls -A "$DOTFILES_USERS_DIR" 2>/dev/null)" ]]; then
        echo -e "  ${YELLOW}No user profiles found${NC}"
        echo -e "  Create one with: ${CYAN}dotfiles user add <username>${NC}"
        return
    fi

    for profile in "$DOTFILES_USERS_DIR"/*.settings; do
        [[ -f "$profile" ]] || continue
        local name=$(basename "$profile" .settings)
        # Load profile safely (no source to avoid code execution)
        local user_theme user_nav
        user_theme=$(safe_read_setting "$profile" "THEME" "unknown")
        user_nav=$(safe_read_setting "$profile" "NAV_STYLE" "unknown")

        if [[ "$name" == "$ACTIVE_USER" ]]; then
            echo -e "  ${GREEN}●${NC} ${GREEN}$name${NC} (theme: $user_theme, nav: $user_nav) ${GREEN}[active]${NC}"
        else
            echo -e "  ○ $name (theme: $user_theme, nav: $user_nav)"
        fi
    done
}

# Interactive theme selection
interactive_select_theme() {
    echo -e "\n${BLUE}Select a theme:${NC}\n"
    local themes=($SUPPORTED_THEMES)
    local i=1
    for theme in "${themes[@]}"; do
        printf "  %2d) %s\n" "$i" "$theme"
        ((i++))
    done
    echo ""

    local selection
    while true; do
        read -rp "Enter number (1-${#themes[@]}): " selection
        if [[ "$selection" =~ ^[0-9]+$ ]] && ((selection >= 1 && selection <= ${#themes[@]})); then
            THEME="${themes[$((selection-1))]}"
            echo -e "${GREEN}Selected: $THEME${NC}"
            return 0
        fi
        echo -e "${RED}Invalid selection. Please enter a number 1-${#themes[@]}${NC}"
    done
}

# Interactive nav style selection
interactive_select_nav() {
    echo -e "\n${BLUE}Select navigation style:${NC}\n"
    echo "  1) emacs - Arrow keys, Ctrl-A/E, beginner-friendly (recommended)"
    echo "  2) vim   - hjkl navigation, modal editing"
    echo ""

    local selection
    while true; do
        read -rp "Enter number (1 or 2): " selection
        case "$selection" in
            1) NAV_STYLE="emacs"; echo -e "${GREEN}Selected: emacs${NC}"; return 0 ;;
            2) NAV_STYLE="vim"; echo -e "${GREEN}Selected: vim${NC}"; return 0 ;;
            *) echo -e "${RED}Invalid selection. Please enter 1 or 2${NC}" ;;
        esac
    done
}

# Interactive keyboard style selection
interactive_select_keyboard() {
    echo -e "\n${BLUE}Enable macOS-style keyboard shortcuts?${NC}\n"
    echo "  This will modify your desktop environment (KDE/GNOME/XFCE) to free up"
    echo "  Super+V (clipboard) and Super+1-9 (taskbar) so Ghostty can use them."
    echo ""
    echo -e "  ${YELLOW}Note: This modifies system-level shortcuts.${NC}"
    echo ""

    local enable
    read -rp "Enable keyboard modifications? [y/N]: " enable
    enable=${enable:-n}

    if [[ ! "$enable" =~ ^[Yy]$ ]]; then
        KEYBOARD_ENABLED="no"
        KEYBOARD_STYLE="linux"
        echo -e "${GREEN}Keyboard modifications disabled${NC}"
        return 0
    fi

    KEYBOARD_ENABLED="yes"
    echo -e "\n${BLUE}Select keyboard style:${NC}\n"
    echo "  1) macos - Super+C/V for copy/paste, Super+1-9 for tabs (Mac keyboard recommended)"
    echo "  2) linux - Standard Linux shortcuts (Ctrl+Shift+C/V)"
    echo ""

    local selection
    while true; do
        read -rp "Enter number (1 or 2): " selection
        case "$selection" in
            1) KEYBOARD_STYLE="macos"; echo -e "${GREEN}Selected: macos${NC}"; return 0 ;;
            2) KEYBOARD_STYLE="linux"; echo -e "${GREEN}Selected: linux${NC}"; return 0 ;;
            *) echo -e "${RED}Invalid selection. Please enter 1 or 2${NC}" ;;
        esac
    done
}

# Full interactive setup for new user
interactive_user_setup() {
    local username="$1"
    echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Setting up profile for: ${CYAN}$username${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

    # Default values
    THEME="catppuccin-mocha"
    NAV_STYLE="emacs"
    KEYBOARD_STYLE="linux"
    KEYBOARD_ENABLED="no"

    interactive_select_theme
    interactive_select_nav
    interactive_select_keyboard

    # Save the profile
    save_user_profile "$username"

    echo -e "\n${GREEN}Profile created for $username!${NC}"
    echo -e "  Theme: ${CYAN}$THEME${NC}"
    echo -e "  Navigation: ${CYAN}$NAV_STYLE${NC}"
    if [[ "$KEYBOARD_ENABLED" == "yes" ]]; then
        echo -e "  Keyboard: ${CYAN}$KEYBOARD_STYLE${NC} (DE shortcuts modified)"
    else
        echo -e "  Keyboard: ${CYAN}standard${NC} (no DE modifications)"
    fi

    # Ask if they want to apply now
    echo ""
    read -rp "Apply these settings now? [Y/n]: " apply
    apply=${apply:-y}
    if [[ "$apply" =~ ^[Yy]$ ]]; then
        ACTIVE_USER="$username"
        apply_theme
        if [[ "$KEYBOARD_ENABLED" == "yes" ]]; then
            apply_keyboard_style
        fi
    fi
}

# Switch to a user profile
switch_to_user() {
    local username="$1"

    if ! validate_username "$username"; then
        return 1
    fi

    # Check if user exists
    if ! user_exists "$username"; then
        echo -e "${YELLOW}User '$username' does not exist.${NC}"
        read -rp "Create new profile for '$username'? [Y/n]: " create
        create=${create:-y}
        if [[ "$create" =~ ^[Yy]$ ]]; then
            interactive_user_setup "$username"
        else
            echo "Aborted."
            return 1
        fi
        return 0
    fi

    # Load user profile
    load_user_profile "$username"
    ACTIVE_USER="$username"
    apply_theme
    if [[ "$KEYBOARD_ENABLED" == "yes" ]]; then
        apply_keyboard_style
    fi
    echo -e "${GREEN}Switched to user: ${CYAN}$username${NC}"
}

# Add a new user profile (explicit creation)
add_user() {
    local username=""
    local theme=""
    local nav=""
    local keyboard=""
    local keyboard_enabled=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --theme)
                theme="$2"
                shift 2
                ;;
            --nav)
                nav="$2"
                shift 2
                ;;
            --keyboard)
                keyboard="$2"
                keyboard_enabled="yes"
                shift 2
                ;;
            *)
                if [[ -z "$username" ]]; then
                    username="$1"
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$username" ]]; then
        echo -e "${RED}Error: username required${NC}"
        echo "Usage: dotfiles user add <username> [--theme <name>] [--nav emacs|vim] [--keyboard macos|linux]"
        return 1
    fi

    if ! validate_username "$username"; then
        return 1
    fi

    if user_exists "$username"; then
        echo -e "${YELLOW}User '$username' already exists.${NC}"
        read -rp "Overwrite profile? [y/N]: " overwrite
        if [[ ! "$overwrite" =~ ^[Yy]$ ]]; then
            echo "Aborted."
            return 1
        fi
    fi

    # If all options are provided, create directly (skip interactive)
    if [[ -n "$theme" && -n "$nav" && -n "$keyboard" ]]; then
        # Validate theme
        if [[ ! " $SUPPORTED_THEMES " =~ " $theme " ]]; then
            echo -e "${RED}Error: Unknown theme '$theme'${NC}"
            list_themes
            return 1
        fi
        # Validate nav
        if [[ "$nav" != "emacs" && "$nav" != "vim" ]]; then
            echo -e "${RED}Error: nav must be 'emacs' or 'vim'${NC}"
            return 1
        fi
        # Validate keyboard
        if [[ "$keyboard" != "macos" && "$keyboard" != "linux" ]]; then
            echo -e "${RED}Error: keyboard must be 'macos' or 'linux'${NC}"
            return 1
        fi
        THEME="$theme"
        NAV_STYLE="$nav"
        KEYBOARD_STYLE="$keyboard"
        KEYBOARD_ENABLED="${keyboard_enabled:-yes}"
        save_user_profile "$username"
        echo -e "${GREEN}Created profile for: ${CYAN}$username${NC}"
        echo -e "  Theme: ${CYAN}$THEME${NC}"
        echo -e "  Navigation: ${CYAN}$NAV_STYLE${NC}"
        echo -e "  Keyboard: ${CYAN}$KEYBOARD_STYLE${NC} (DE mods enabled)"
    else
        # Interactive setup
        interactive_user_setup "$username"
    fi
}

# Delete a user profile
delete_user() {
    local username="$1"

    if [[ -z "$username" ]]; then
        echo -e "${RED}Error: username required${NC}"
        echo "Usage: dotfiles user delete <username>"
        return 1
    fi

    if ! user_exists "$username"; then
        echo -e "${RED}Error: User '$username' does not exist${NC}"
        return 1
    fi

    load_settings

    if [[ "$username" == "$ACTIVE_USER" ]]; then
        echo -e "${YELLOW}Warning: '$username' is the active user${NC}"
    fi

    read -rp "Delete profile for '$username'? [y/N]: " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        rm -f "$DOTFILES_USERS_DIR/${username}.settings"
        echo -e "${GREEN}Deleted profile: $username${NC}"

        if [[ "$username" == "$ACTIVE_USER" ]]; then
            ACTIVE_USER=""
            save_settings
            echo -e "${YELLOW}Note: Switch to another user with 'dotfiles user <name>'${NC}"
        fi
    else
        echo "Aborted."
    fi
}

# ============================================================================
# THEME UPDATE FUNCTIONS
# ============================================================================

# Update Ghostty theme
update_ghostty() {
    load_theme_colors
    mkdir -p ~/.config/ghostty/themes
    cat > ~/.config/ghostty/themes/dotfiles-theme << EOF
# Generated by dotfiles - Theme: $THEME
background = ${T_BG}
foreground = ${T_FG}
cursor-color = ${T_CURSOR}
cursor-text = ${T_CURSOR_TEXT}
selection-background = ${T_SEL_BG}
selection-foreground = ${T_SEL_FG}
palette = 0=${T_BLACK}
palette = 8=${T_BRIGHT_BLACK}
palette = 1=${T_RED}
palette = 9=${T_BRIGHT_RED}
palette = 2=${T_GREEN}
palette = 10=${T_BRIGHT_GREEN}
palette = 3=${T_YELLOW}
palette = 11=${T_BRIGHT_YELLOW}
palette = 4=${T_BLUE}
palette = 12=${T_BRIGHT_BLUE}
palette = 5=${T_MAGENTA}
palette = 13=${T_BRIGHT_MAGENTA}
palette = 6=${T_CYAN}
palette = 14=${T_BRIGHT_CYAN}
palette = 7=${T_WHITE}
palette = 15=${T_BRIGHT_WHITE}
EOF
}

# Update tmux theme
update_tmux() {
    load_theme_colors
    # Remove old theme lines and add new ones
    if [[ -f ~/.tmux.conf ]]; then
        sed_i '/^# Theme:/d; /^set -g status-style/d; /^set -g status-left /d; /^set -g status-right /d' ~/.tmux.conf
        sed_i '/^setw -g window-status-current-style/d; /^setw -g window-status-current-format/d' ~/.tmux.conf
        sed_i '/^setw -g window-status-style/d; /^setw -g window-status-format/d; /^setw -g window-status-separator/d' ~/.tmux.conf
        sed_i '/^set -g pane-border-style/d; /^set -g pane-active-border-style/d' ~/.tmux.conf
        sed_i '/^set -g message-style/d; /^setw -g mode-style/d' ~/.tmux.conf

        cat >> ~/.tmux.conf << EOF
# Theme: $THEME (generated by dotfiles)
set -g status-style 'bg=${T_BG} fg=${T_FG}'
set -g status-left '#[fg=${T_BG},bg=${T_ACCENT},bold]  #S #[fg=${T_ACCENT},bg=${T_BG}]'
set -g status-right '#[fg=${T_OVERLAY}]#[fg=${T_FG},bg=${T_OVERLAY}] %H:%M #[fg=${T_ACCENT}]#[fg=${T_BG},bg=${T_ACCENT},bold] %d %b '
setw -g window-status-current-style 'fg=${T_BG} bg=${T_ACCENT2} bold'
setw -g window-status-current-format '#[fg=${T_BG},bg=${T_ACCENT2}]#[fg=${T_BG},bg=${T_ACCENT2}] #I  #W #[fg=${T_ACCENT2},bg=${T_BG}]'
setw -g window-status-style 'fg=${T_MUTED} bg=${T_BG}'
setw -g window-status-format '  #I  #W  '
setw -g window-status-separator ''
set -g pane-border-style 'fg=${T_OVERLAY}'
set -g pane-active-border-style 'fg=${T_ACCENT}'
set -g message-style 'bg=${T_YELLOW} fg=${T_BG} bold'
setw -g mode-style 'bg=${T_ACCENT3} fg=${T_BG} bold'
EOF
    fi
}

# Update fzf colors in zshrc
update_fzf() {
    load_theme_colors
    local fzf_colors="export FZF_DEFAULT_OPTS=\"\$FZF_DEFAULT_OPTS \\
  --color=fg:${T_FG},bg:-1,hl:${T_ACCENT3} \\
  --color=fg+:${T_FG},bg+:${T_SURFACE},hl+:${T_ACCENT3} \\
  --color=info:${T_MAGENTA},prompt:${T_CYAN},pointer:${T_CURSOR} \\
  --color=marker:${T_CURSOR},spinner:${T_CURSOR},header:${T_CYAN} \\
  --prompt='  ' --pointer='▶' --marker='✓'\""

    if [[ -f ~/.zshrc ]]; then
        # Remove old fzf colors and replace
        sed_i '/^export FZF_DEFAULT_OPTS=.*--color=/d' ~/.zshrc
        sed_i '/^  --color=/d' ~/.zshrc
        # Add new colors after the placeholder comment
        sed_i "s|# fzf colors.*|# fzf colors ($THEME)\n$fzf_colors|" ~/.zshrc
    fi
}

# Update yazi theme
update_yazi() {
    load_theme_colors
    mkdir -p ~/.config/yazi
    cat > ~/.config/yazi/theme.toml << EOF
# Theme: $THEME (generated by dotfiles)
[manager]
cwd = { fg = "${T_CYAN}" }
hovered = { fg = "${T_BG}", bg = "${T_ACCENT}" }
preview_hovered = { underline = true }
find_keyword = { fg = "${T_YELLOW}", bold = true, italic = true, underline = true }
find_position = { fg = "${T_ACCENT3}", bg = "reset", bold = true }
marker_copied = { fg = "${T_GREEN}", bg = "${T_GREEN}" }
marker_cut = { fg = "${T_ACCENT3}", bg = "${T_ACCENT3}" }
marker_marked = { fg = "${T_ACCENT}", bg = "${T_ACCENT}" }
marker_selected = { fg = "${T_YELLOW}", bg = "${T_YELLOW}" }
tab_active = { fg = "${T_BG}", bg = "${T_FG}" }
tab_inactive = { fg = "${T_FG}", bg = "${T_OVERLAY}" }
border_symbol = "│"
border_style = { fg = "${T_MUTED}" }
[status]
separator_open = ""
separator_close = ""
separator_style = { fg = "${T_OVERLAY}", bg = "${T_OVERLAY}" }
mode_normal = { fg = "${T_BG}", bg = "${T_ACCENT}", bold = true }
mode_select = { fg = "${T_BG}", bg = "${T_ACCENT2}", bold = true }
progress_label = { fg = "${T_FG}", bold = true }
progress_normal = { fg = "${T_ACCENT}", bg = "${T_OVERLAY}" }
progress_error = { fg = "${T_ACCENT3}", bg = "${T_OVERLAY}" }
permissions_t = { fg = "${T_ACCENT}" }
permissions_r = { fg = "${T_YELLOW}" }
permissions_w = { fg = "${T_ACCENT3}" }
permissions_x = { fg = "${T_GREEN}" }
permissions_s = { fg = "${T_MUTED}" }
[input]
border = { fg = "${T_ACCENT}" }
title = {}
value = {}
selected = { reversed = true }
[select]
border = { fg = "${T_ACCENT}" }
active = { fg = "${T_ACCENT3}", bold = true }
inactive = {}
[tasks]
border = { fg = "${T_ACCENT}" }
title = {}
hovered = { fg = "${T_ACCENT3}", underline = true }
[which]
cols = 3
mask = { bg = "${T_SURFACE}" }
cand = { fg = "${T_CYAN}" }
rest = { fg = "${T_MUTED}" }
desc = { fg = "${T_ACCENT3}" }
separator = "  "
separator_style = { fg = "${T_OVERLAY}" }
[help]
on = { fg = "${T_CYAN}" }
run = { fg = "${T_ACCENT3}" }
desc = {}
hovered = { reversed = true, bold = true }
footer = { fg = "${T_OVERLAY}", bg = "${T_FG}" }
[filetype]
rules = [
  { mime = "image/*", fg = "${T_YELLOW}" },
  { mime = "video/*", fg = "${T_ACCENT3}" },
  { mime = "audio/*", fg = "${T_ACCENT3}" },
  { mime = "application/zip", fg = "${T_MAGENTA}" },
  { mime = "application/gzip", fg = "${T_MAGENTA}" },
  { mime = "application/x-tar", fg = "${T_MAGENTA}" },
  { mime = "application/pdf", fg = "${T_ACCENT3}" },
  { name = "*", fg = "${T_FG}" },
  { name = "*/", fg = "${T_ACCENT}" },
]
EOF
}

# Update bat config
update_bat() {
    load_theme_colors
    mkdir -p ~/.config/bat
    cat > ~/.config/bat/config << EOF
--theme="${T_BAT_THEME}"
--style="numbers,changes,header"
--italic-text=always
--paging=auto
EOF
}

# Update all theme configs
apply_theme() {
    echo -e "${BLUE}Applying theme: ${CYAN}$THEME${NC}"
    update_ghostty
    update_tmux
    update_fzf
    update_yazi
    update_bat
    save_settings
    echo -e "${GREEN}✓${NC} Theme applied! Restart your terminal or reload configs."
    echo -e "  • tmux: ${CYAN}tmux source ~/.tmux.conf${NC}"
    echo -e "  • zsh:  ${CYAN}source ~/.zshrc${NC}"
    echo -e "  • ghostty: ${CYAN}Ctrl-Shift-,${NC} to reload"
}

# Apply keyboard style (macos = Super+C/V, linux = Ctrl+Shift+C/V)
apply_keyboard_style() {
    local style="${KEYBOARD_STYLE:-macos}"
    echo -e "${BLUE}Applying keyboard style: ${CYAN}$style${NC}"

    # Detect desktop environment
    local de="${XDG_CURRENT_DESKTOP:-}"
    de="${de,,}"

    # Detect by tools if XDG_CURRENT_DESKTOP is empty
    if [[ -z "$de" ]]; then
        if command -v kwriteconfig6 &>/dev/null || command -v kwriteconfig5 &>/dev/null; then
            de="kde"
        elif command -v gsettings &>/dev/null && gsettings list-schemas 2>/dev/null | grep -q "org.gnome"; then
            de="gnome"
        elif command -v xfconf-query &>/dev/null; then
            de="xfce"
        fi
    fi

    case "$de" in
        *kde*|*plasma*)
            apply_keyboard_kde "$style"
            ;;
        *gnome*|*ubuntu*)
            apply_keyboard_gnome "$style"
            ;;
        *xfce*)
            apply_keyboard_xfce "$style"
            ;;
        *)
            if [[ -z "$de" ]]; then
                echo -e "${YELLOW}No desktop environment detected - keyboard shortcuts unchanged${NC}"
            else
                echo -e "${YELLOW}Unknown DE: $de - keyboard shortcuts unchanged${NC}"
            fi
            return 0
            ;;
    esac
}

apply_keyboard_kde() {
    local style="$1"
    local kwrite=""

    if command -v kwriteconfig6 &>/dev/null; then
        kwrite="kwriteconfig6"
    elif command -v kwriteconfig5 &>/dev/null; then
        kwrite="kwriteconfig5"
    else
        echo -e "${YELLOW}kwriteconfig not found${NC}"
        return 1
    fi

    if [[ "$style" == "macos" ]]; then
        # macOS style: Free up Super+C/V/1-9 for Ghostty
        # Clipboard shortcut exists in BOTH org.kde.klipper and plasmashell sections
        $kwrite --file kglobalshortcutsrc --group org.kde.klipper \
            --key "show-on-mouse-pos" "Alt+V,Meta+V,Show Clipboard Items at Mouse Position" 2>/dev/null
        $kwrite --file kglobalshortcutsrc --group plasmashell \
            --key "show-on-mouse-pos" "Alt+V,Meta+V,Show Clipboard Items at Mouse Position" 2>/dev/null
        for i in {1..9}; do
            $kwrite --file kglobalshortcutsrc --group plasmashell \
                --key "activate task manager entry $i" "none,Meta+$i,Activate Task Manager Entry $i" 2>/dev/null
        done
        echo -e "${GREEN}✓${NC} KDE: Clipboard moved to Alt+V, Super+1-9 freed for Ghostty"
    else
        # Linux style: Restore defaults
        $kwrite --file kglobalshortcutsrc --group org.kde.klipper \
            --key "show-on-mouse-pos" "Meta+V,Meta+V,Show Clipboard Items at Mouse Position" 2>/dev/null
        $kwrite --file kglobalshortcutsrc --group plasmashell \
            --key "show-on-mouse-pos" "Meta+V,Meta+V,Show Clipboard Items at Mouse Position" 2>/dev/null
        for i in {1..9}; do
            $kwrite --file kglobalshortcutsrc --group plasmashell \
                --key "activate task manager entry $i" "Meta+$i,Meta+$i,Activate Task Manager Entry $i" 2>/dev/null
        done
        echo -e "${GREEN}✓${NC} KDE: Restored default shortcuts (Super+V clipboard, Super+1-9 taskbar)"
    fi

    # Reload shortcuts
    qdbus org.kde.kglobalaccel /kglobalaccel reloadConfig 2>/dev/null || true
    echo -e "${YELLOW}Log out/in for full effect${NC}"
}

apply_keyboard_gnome() {
    local style="$1"

    if [[ "$style" == "macos" ]]; then
        # Disable Super+1-9 app switching
        for i in {1..9}; do
            gsettings set org.gnome.shell.keybindings switch-to-application-$i "[]" 2>/dev/null || true
        done
        echo -e "${GREEN}✓${NC} GNOME: Super+1-9 freed for Ghostty"
    else
        # Restore defaults
        for i in {1..9}; do
            gsettings reset org.gnome.shell.keybindings switch-to-application-$i 2>/dev/null || true
        done
        echo -e "${GREEN}✓${NC} GNOME: Restored default Super+1-9 app switching"
    fi
}

apply_keyboard_xfce() {
    local style="$1"

    if [[ "$style" == "macos" ]]; then
        for i in {1..9}; do
            xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/<Super>$i" -r 2>/dev/null || true
            xfconf-query -c xfce4-keyboard-shortcuts -p "/xfwm4/custom/<Super>$i" -r 2>/dev/null || true
        done
        echo -e "${GREEN}✓${NC} XFCE: Super+1-9 freed for Ghostty"
    else
        echo -e "${GREEN}✓${NC} XFCE: Using default shortcuts"
    fi
}

# Show status
show_status() {
    load_settings
    echo -e "${BLUE}Current Settings:${NC}"
    if [[ -n "$ACTIVE_USER" ]]; then
        echo -e "  User:       ${CYAN}$ACTIVE_USER${NC}"
    fi
    echo -e "  Theme:      ${CYAN}$THEME${NC}"
    echo -e "  Navigation: ${CYAN}$NAV_STYLE${NC}"
    if [[ "$KEYBOARD_ENABLED" == "yes" ]]; then
        echo -e "  Keyboard:   ${CYAN}$KEYBOARD_STYLE${NC} (DE mods enabled)"
    else
        echo -e "  Keyboard:   ${CYAN}standard${NC} (no DE modifications)"
    fi
}

# List themes
list_themes() {
    echo -e "${BLUE}Available Themes:${NC}"
    for theme in $SUPPORTED_THEMES; do
        if [[ "$theme" == "$THEME" ]]; then
            echo -e "  ${GREEN}●${NC} $theme ${GREEN}(current)${NC}"
        else
            echo -e "  ○ $theme"
        fi
    done
}

# ============================================================================
# BACKUP & RESTORE (for CLI)
# ============================================================================
DOTFILES_BACKUP_DIR="$DOTFILES_CONFIG_DIR/backups"

# List available backup sessions
list_backups() {
    echo -e "${BLUE}Available Backups:${NC}"
    if [[ ! -d "$DOTFILES_BACKUP_DIR" ]]; then
        echo "  No backups found"
        echo -e "  Backups are created when running ${CYAN}dotfiles-setup${NC}"
        return
    fi

    local count=0
    for backup in "$DOTFILES_BACKUP_DIR"/*/; do
        [[ -d "$backup" ]] || continue
        local name=$(basename "$backup")
        local manifest="$backup/manifest.txt"
        if [[ -f "$manifest" ]]; then
            local files=$(grep -c "|yes" "$manifest" 2>/dev/null || echo "0")
            echo -e "  ${CYAN}$name${NC} - $files files backed up"
            ((count++))
        fi
    done

    if [[ $count -eq 0 ]]; then
        echo "  No backups found"
    fi
}

# Restore from a backup session
restore_backup() {
    local session="${1:-}"

    if [[ -z "$session" ]]; then
        session=$(ls -1t "$DOTFILES_BACKUP_DIR" 2>/dev/null | head -1)
        if [[ -z "$session" ]]; then
            echo -e "${RED}Error: No backups found${NC}"
            return 1
        fi
        echo -e "Using most recent backup: ${CYAN}$session${NC}"
    fi

    local backup_dir="$DOTFILES_BACKUP_DIR/$session"
    local manifest="$backup_dir/manifest.txt"

    if [[ ! -f "$manifest" ]]; then
        echo -e "${RED}Error: Backup not found: $session${NC}"
        return 1
    fi

    echo -e "${YELLOW}This will restore configs to the state before dotfiles-setup was run.${NC}"
    echo -e "${YELLOW}Files created by dotfiles-setup will be removed.${NC}"
    echo ""
    read -rp "Continue with restore? [y/N]: " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Restore cancelled."
        return 1
    fi

    local restored=0 removed=0 errors=0

    while IFS='|' read -r original backup existed type || [[ -n "$original" ]]; do
        [[ "$original" =~ ^# ]] && continue
        [[ -z "$original" ]] && continue

        if [[ "$existed" == "yes" ]]; then
            if [[ "$type" == "directory" ]]; then
                if [[ -d "$backup" ]]; then
                    rm -rf "$original" 2>/dev/null
                    cp -rp "$backup" "$original" && ((restored++)) || ((errors++))
                fi
            else
                if [[ -f "$backup" ]]; then
                    mkdir -p "$(dirname "$original")"
                    cp -p "$backup" "$original" && ((restored++)) || ((errors++))
                fi
            fi
        else
            if [[ "$type" == "directory" ]]; then
                [[ -d "$original" ]] && rm -rf "$original" && ((removed++))
            else
                [[ -f "$original" ]] && rm -f "$original" && ((removed++))
            fi
        fi
    done < "$manifest"

    echo -e "${GREEN}✓${NC} Restore complete: $restored files restored, $removed files removed"
    [[ $errors -gt 0 ]] && echo -e "${YELLOW}⚠${NC} $errors errors occurred"
    echo -e "\nRestart your terminal for changes to take effect."
}

# Show help
show_help() {
    cat << EOF
${BLUE}dotfiles${NC} - Terminal environment management

${YELLOW}USAGE${NC}
    dotfiles <command> [args]

${YELLOW}COMMANDS${NC}
    theme <name>       Set color theme
    nav <style>        Set navigation style (emacs|vim)
    keyboard <style>   Set keyboard style (macos|linux)
    list-themes        Show available themes
    status             Show current settings
    help               Show this help

${YELLOW}BACKUP & RESTORE${NC}
    backups            List available backup sessions
    restore [name]     Restore from backup (most recent if no name)

${YELLOW}USER COMMANDS${NC}
    user <name>        Switch to user profile (creates if new)
    --<Name>           Quick switch (e.g., dotfiles --Pratik)
    user add <name>    Create user profile
    user delete <name> Delete a user profile
    users              List all user profiles

${YELLOW}EXAMPLES${NC}
    dotfiles theme dracula
    dotfiles nav vim
    dotfiles keyboard macos         # Cmd+C/V/1-9 in Ghostty
    dotfiles --Pratik               # Quick switch to Pratik
    dotfiles user NickMC            # Switch to NickMC
    dotfiles user add TimPike --theme nord --nav vim --keyboard macos
    dotfiles users                  # List all profiles

${YELLOW}KEYBOARD STYLES${NC}
    macos  - Super+C/V for copy/paste, Super+1-9 for tabs (Mac-like)
    linux  - Traditional Ctrl+Shift+C/V, restore DE defaults

${YELLOW}THEMES${NC}
    catppuccin-mocha (default), catppuccin-latte, catppuccin-frappe,
    catppuccin-macchiato, dracula, gruvbox-dark, gruvbox-light,
    nord, tokyo-night, solarized-dark, solarized-light, monokai, rose-pine
EOF
}

# Main
load_settings

case "${1:-}" in
    theme)
        if [[ -z "${2:-}" ]]; then
            echo -e "${RED}Error: theme name required${NC}"
            echo "Usage: dotfiles theme <name>"
            list_themes
            exit 1
        fi
        if [[ ! " $SUPPORTED_THEMES " =~ " $2 " ]]; then
            echo -e "${RED}Error: Unknown theme '$2'${NC}"
            list_themes
            exit 1
        fi
        THEME="$2"
        apply_theme
        ;;
    nav)
        if [[ "${2:-}" != "emacs" && "${2:-}" != "vim" ]]; then
            echo -e "${RED}Error: nav style must be 'emacs' or 'vim'${NC}"
            exit 1
        fi
        NAV_STYLE="$2"
        save_settings
        echo -e "${GREEN}✓${NC} Navigation style set to ${CYAN}$NAV_STYLE${NC}"
        echo -e "${YELLOW}Note:${NC} Re-run dotfiles-setup to apply navigation changes."
        ;;
    keyboard|kbd)
        if [[ "${2:-}" != "macos" && "${2:-}" != "linux" ]]; then
            echo -e "${RED}Error: keyboard style must be 'macos' or 'linux'${NC}"
            echo "  macos - Super+C/V for copy/paste, Super+1-9 for tabs"
            echo "  linux - Traditional shortcuts, restore DE defaults"
            exit 1
        fi
        KEYBOARD_STYLE="$2"
        KEYBOARD_ENABLED="yes"
        save_settings
        apply_keyboard_style
        ;;
    list-themes|themes)
        list_themes
        ;;
    backups|list-backups)
        list_backups
        ;;
    restore)
        restore_backup "${2:-}"
        ;;
    status)
        show_status
        ;;
    help|--help|-h)
        show_help
        ;;
    user)
        case "${2:-}" in
            add)
                shift 2
                add_user "$@"
                ;;
            delete|remove|rm)
                delete_user "${3:-}"
                ;;
            "")
                echo -e "${RED}Error: username required${NC}"
                echo "Usage: dotfiles user <username>"
                echo "       dotfiles user add <username> [--theme <name>] [--nav emacs|vim] [--keyboard macos|linux]"
                exit 1
                ;;
            *)
                switch_to_user "$2"
                ;;
        esac
        ;;
    users)
        list_users
        ;;
    --*)
        # Quick switch: --Username syntax
        username="${1#--}"
        if [[ -n "$username" ]] && validate_username "$username" 2>/dev/null; then
            switch_to_user "$username"
        else
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
        fi
        ;;
    "")
        show_status
        echo ""
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac
DOTFILES_CLI_EOF
    chmod +x ~/.local/bin/dotfiles

    print_success "Utility scripts created"
}

# ============================================================================
# NVIM SETUP
# ============================================================================

setup_nvim() {
    print_header "Setting Up Neovim"

    if [[ ! -d ~/.config/nvim/.git ]]; then
        # Backup existing nvim config before replacing
        [[ -n "${BACKUP_SESSION_DIR:-}" ]] && backup_directory "$HOME/.config/nvim"

        print_step "Cloning Kickstart.nvim..."
        rm -rf ~/.config/nvim
        git clone https://github.com/nvim-lua/kickstart.nvim.git ~/.config/nvim
        print_success "Kickstart.nvim installed"
        print_warning "Run 'nvim' to complete plugin installation"
        print_warning "Add Catppuccin theme: edit ~/.config/nvim/init.lua"
    else
        print_success "Neovim config already exists"
    fi
}

# ============================================================================
# SET DEFAULT SHELL
# ============================================================================

set_default_shell() {
    print_header "Setting Default Shell"

    if [[ "$SHELL" != *"zsh"* ]]; then
        print_step "Changing default shell to zsh..."
        if [[ "$OS" == "macos" ]]; then
            chsh -s /bin/zsh
        else
            chsh -s "$(which zsh)"
        fi
        print_success "Default shell changed to zsh"
        print_warning "Log out and back in for changes to take effect"
    else
        print_success "Zsh is already the default shell"
    fi
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    # Initialize backup session (unless --no-backup)
    if [[ "$SKIP_BACKUP" != "true" ]]; then
        print_header "Initializing Backup"
        init_backup_session
        echo -e "All existing configs will be backed up before modification."
        echo -e "To restore: ${CYAN}dotfiles-setup --restore${NC}"
        echo ""
    else
        print_warning "Backup disabled (--no-backup). Existing configs may be overwritten."
    fi

    # Load theme colors for setup
    load_theme_colors

    install_packages
    setup_directories
    setup_zsh
    setup_tmux
    setup_ghostty
    setup_de_shortcuts
    setup_yazi
    setup_git
    setup_bat
    setup_utilities
    setup_nvim
    set_default_shell

    # Save current settings
    save_settings

    print_header "Setup Complete!"
    echo -e "Theme: ${PURPLE}$THEME${NC}"
    echo -e "Navigation: ${CYAN}$NAV_STYLE${NC}\n"
    echo -e "Next steps:"
    echo -e "  1. ${CYAN}source ~/.zshrc${NC} or restart terminal"
    echo -e "  2. ${CYAN}tmux${NC} to start tmux"
    echo -e "  3. ${CYAN}nvim${NC} to finish plugin installation"
    echo -e "  4. ${CYAN}p10k configure${NC} to customize prompt"
    echo -e "  5. ${CYAN}hk${NC} to see hotkey reference"
    echo -e "\nTo change theme/navigation anytime:"
    echo -e "  ${CYAN}dotfiles theme <name>${NC}  - Switch theme"
    echo -e "  ${CYAN}dotfiles list-themes${NC}   - Show available themes"
    echo -e "\n${GREEN}Enjoy your new terminal!${NC}\n"
}

# Run main
main "$@"
